<!DOCTYPE html>
<html lang="en">
   <head>
      <meta charset="utf-8">
      <meta http-equiv="X-UA-Compatible" content="IE=edge">
      <meta name="viewport" content="initial-scale=1,user-scalable=no,maximum-scale=1,width=device-width">
      <meta name="mobile-web-app-capable" content="yes">
      <meta name="apple-mobile-web-app-capable" content="yes">
      <meta name="theme-color" content="#000000">
      <meta name="description" content="Map based Archaeoastronomic Calculation and Exploration.">
      <title>MACE</title>
	  <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/leaflet.js" integrity="sha512-XQoYMqMTK8LvdxXYG3nZ448hOEQiglfqkJs1NOQV44cWnUrBc8PkAOcXy20w0vlaXaVUearIOBhiXZ5V3ynxwA==" crossorigin="anonymous"></script>
      <script src="assets/js/vendor.js"></script>
      <script src="assets/js/leaflet.distortableimage.js"></script>
	  <script src="https://unpkg.com/leaflet.heat@0.2.0/dist/leaflet-heat.js"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.js" integrity="sha512-n/4gHW3atM3QqRcbCn6ewmpxcLAHGaDjpEBu4xZd47N0W2oQ+6q7oc3PXstrJYXcbNU1OHdQ1T7pAP+gi5Yu8g==" crossorigin="anonymous"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js" integrity="sha512-uto9mlQzrs59VwILcLiRYeLKPPbS/bT71da/OEBYEwcdNUk8jYIy+D176RYoop1Da+f9mvkYrmj5MCLZWEtQuA==" crossorigin="anonymous"></script>
      <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.css" integrity="sha512-aOG0c6nPNzGk+5zjwyJaoRUgCdOrfSDhmMID2u4+OIslr0GjpLKo7Xm0Ao3xmpM4T8AmIouRkqwj1nrdVsLKEQ==" crossorigin="anonymous" />
      <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
      <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.5/css/bootstrap.css" integrity="sha512-++bHK0UNrNHW3LVNLzgTm2G7uOH6Kd+Ved0sskOL0+TY7pr5AcWQgR19kdjAhyyiQRDjFwXubDGqTvjnS09HNA==" crossorigin="anonymous" />
      <link rel="stylesheet" href="assets/css/lobipanel.min.css"/>
      <link rel="stylesheet" href="assets/css/Control.Coordinates.css" />
      <link rel="stylesheet" href="assets/css/L.Control.Locate.css">
      <link rel="stylesheet" href="assets/css/leaflet.zoomhome.css"/>
      <link rel="stylesheet" href="assets/css/app.css">
      <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/leaflet.css" integrity="sha512-xodZBNTC5n17Xt2atTPuE1HxjVMSvLVW9ocqUKLsCC5CXdbqCmblAshOMAS6/keqq/sMZMZ19scR4PsZChSR7A==" crossorigin="anonymous" />
      <link rel="stylesheet" href="assets/css/vendor.css">
      <link rel="stylesheet" href="assets/css/leaflet.distortableimage.css" media="screen" title="no title">
      <link rel="stylesheet" href="assets/css/leaflet.fullscreen.css" />
      <link rel="preconnect" href="https://fonts.googleapis.com">
      <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
      <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;600;700&family=Lora:ital@0;1&display=swap" rel="stylesheet">
      <link rel="stylesheet" href="assets/css/scrollbar.css" />
      <link rel="stylesheet" href="assets/css/leaflet-sidebar.css" />
      <link rel="stylesheet" href="assets/css/jquery.treegrid.css" />
      <link rel="stylesheet" href="assets/css/titatoggle-dist.css" />
      <link href='https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css' rel='stylesheet' />
      <!-- Image Upload Custom styles -->
      <link href="assets/imageoverlaycss/jquery.dm-uploader.min.css" rel="stylesheet">
      <link href="assets/imageoverlaycss/styles.css" rel="stylesheet">
      <style>
         .padding {
         padding-right: 50px;
         padding-bottom: 25px;
         padding-left: 50px;
         }
      </style>
      <link rel="apple-touch-icon" sizes="180x180" href="assets/img/apple-touch-icon.png">
      <link rel="icon" type="image/png" sizes="32x32" href="assets/img/favicon-32x32.png">
      <link rel="icon" type="image/png" sizes="16x16" href="assets/img/favicon-16x16.png">
      <link rel="mask-icon" href="assets/img/safari-pinned-tab.svg" color="#5bbad5">
      <meta name="msapplication-TileColor" content="#da532c">
      <meta name="theme-color" content="#ffffff">
      <link rel="icon" type="image/x-icon" href="assets/img/favicon.ico">
      <style>
         :root {
            /* Color Variables */
            --ai-green: #023020;
            --ai-orange: #ffa500;
            --ai-blue: #2487CE;
            --gray-100: #f3f4f6;
            --radius: 0.375rem;
         }
         
         /* Apply Montserrat font throughout the application */
         body, html {
            font-family: 'Montserrat', sans-serif !important;
         }
         * {
            font-family: 'Montserrat', sans-serif;
         }
         .leaflet-container.crosshair-cursor-enabled {
         cursor: crosshair;
         }
         .btn {
         border-radius: 0px;
         }
         
         /* --- Navbar Header Styles --- */
         .navbar-default {
            background-color: var(--ai-green) !important;
            border-color: var(--ai-green) !important;
            height: 50px;
            min-height: 50px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
         }
         
         .navbar-default .container-fluid {
            display: flex;
            align-items: center;
            height: 50px;
            padding: 0 1rem;
         }
         
         .navbar-default .navbar-header {
            display: flex;
            align-items: center;
            height: 50px;
            flex: 0 0 auto;
         }
         
         /* Mobile Toggle Button */
         .mobile-toggle {
            display: none;
            margin-right: 1rem;
            color: white !important;
            background: none;
            border: none;
            font-size: 1.25rem;
            cursor: pointer;
            padding: 0;
         }
         
         /* Responsive Rule for Mobile Toggle */
         @media (max-width: 768px) {
            .mobile-toggle {
               display: block;
            }
         }
         
         /* Dot Circle Icon */
         .header-icon {
            font-size: 3.645rem; /* Reduced by 10% from 4.05rem */
            color: var(--ai-orange) !important;
            margin-right: 0.5rem;
         }
         
         /* Header Title Styling */
         .header-title {
            font-weight: 300;
            font-size: 2.2rem;
            white-space: nowrap;
            color: white !important;
            margin: 0;
            padding: 0;
            display: inline-block;
         }
         
         /* Flexible Spacer */
         .navbar-spacer {
            flex-grow: 1;
         }
         
         /* MACE Brand Styling */
         .navbar-default .navbar-brand {
            font-weight: 700;
            font-size: 3rem;
            color: white !important;
            padding: 0;
            margin: 0 1rem 0 0;
            display: flex;
            align-items: center;
         }
         
         /* GitHub Button Styling */
         .github-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 32px;
            height: 32px;
            border: 1px solid var(--ai-blue);
            border-radius: var(--radius);
            color: var(--ai-blue) !important;
            text-decoration: none;
            transition: background 0.2s;
            box-sizing: border-box;
         }
         .github-btn:hover {
            background-color: rgba(255,255,255,0.1);
            color: var(--ai-blue) !important;
         }
         .github-btn i {
            color: var(--ai-blue) !important;
            font-size: 1.5em;
         }
         .navbar-default .navbar-text {
         color: #fafafa;
         }
         .navbar-default .navbar-nav > li > a {
         color: #fafafa;
         }
         .navbar-default .navbar-nav > li > a:hover,
         .navbar-default .navbar-nav > li > a:focus {
         color: #d0d6e2;
         }
         .navbar-default .navbar-nav > li > .dropdown-menu {
         background-color: #1c2a48;
         }
         .navbar-default .navbar-nav > li > .dropdown-menu > li > a {
         color: #fafafa;
         }
         .navbar-default .navbar-nav > li > .dropdown-menu > li > a:hover,
         .navbar-default .navbar-nav > li > .dropdown-menu > li > a:focus {
         color: #d0d6e2;
         background-color: #2e3951;
         }
         .navbar-default .navbar-nav > li > .dropdown-menu > li.divider {
         background-color: #2e3951;
         }
         .navbar-default .navbar-nav .open .dropdown-menu > .active > a,
         .navbar-default .navbar-nav .open .dropdown-menu > .active > a:hover,
         .navbar-default .navbar-nav .open .dropdown-menu > .active > a:focus {
         color: #d0d6e2;
         background-color: #2e3951;
         }
         .navbar-default .navbar-nav > .active > a,
         .navbar-default .navbar-nav > .active > a:hover,
         .navbar-default .navbar-nav > .active > a:focus {
         color: #d0d6e2;
         background-color: #2e3951;
         }
         .navbar-default .navbar-nav > .open > a,
         .navbar-default .navbar-nav > .open > a:hover,
         .navbar-default .navbar-nav > .open > a:focus {
         color: #d0d6e2;
         background-color: #2e3951;
         }
         .navbar-default .navbar-toggle {
         border-color: #2e3951;
         }
         .navbar-default .navbar-toggle:hover,
         .navbar-default .navbar-toggle:focus {
         background-color: #2e3951;
         }
         .navbar-default .navbar-toggle .icon-bar {
         background-color: #fafafa;
         }
         .navbar-default .navbar-collapse,
         .navbar-default .navbar-form {
         border-color: #fafafa;
         }
         .navbar-default .navbar-link {
         color: #fafafa;
         }
         .navbar-default .navbar-link:hover {
         color: #d0d6e2;
         }
         @media (max-width: 767px) {
         .navbar-default .navbar-nav .open .dropdown-menu > li > a {
         color: #fafafa;
         }
         .navbar-default .navbar-nav .open .dropdown-menu > li > a:hover,
         .navbar-default .navbar-nav .open .dropdown-menu > li > a:focus {
         color: #d0d6e2;
         }
         .navbar-default .navbar-nav .open .dropdown-menu > .active > a,
         .navbar-default .navbar-nav .open .dropdown-menu > .active > a:hover,
         .navbar-default .navbar-nav .open .dropdown-menu > .active > a:focus {
         color: #d0d6e2;
         background-color: #2e3951;
         }
         .redtext {
         color: #00ff00;
         }
         .affixed{
         position:fixed;
         top:50px;
         }
      </style>
      <style>
         .disableScroll{
         overflow-y:hidden;
         overflow-x:hidden;
         }
         #AZlist.dropdown-menu{
         min-width: 325px;
         max-width: 325px;
         }
         .list-inline {
         padding-left: 0;
         margin-left: 5px;
         list-style: none;
         }
         .rightpadding {
         padding-right: 15px;
         padding-bottom: 25px;
         }
         .rightpadding20 {
         padding-right: 20px;
         }
      </style>
      <style>
         .solstice-bg{color:#000; background-color: #fff3e0;}
         .solsticefb-bg{color:#000; background-color: #ffe0b2;}
         .solsticelat-bg{color:#000; background-color: #ffcc80;}
         .solsticelong-bg{color:#000; background-color: #ffb74d;}
         .equinox-bg{color:#000; background-color: #fffde7;}
         .equinoxfb-bg{color:#000; background-color: #fff9c4 ;}
         .equinoxlat-bg{color:#000; background-color: #fff59d;}
         .equinoxlong-bg{color:#000; background-color: #fff176 ;}
         .crossquarter-bg{color:#000; background-color: #f1f8e9;}
         .crossquarterfb-bg{color:#000; background-color: #dcedc8;}
         .crossquarterlat-bg{color:#000; background-color: #c5e1a5;}
         .crossquarterlong-bg{color:#000; background-color: #aed581;}
         .major-bg{color:#000; background-color: #d0d6e2;}
         .majorfb-bg{color:#000; background-color: #b1bace;}
         .majorlat-bg{color:#000; background-color: #929fba;}
         .majorlong-bg{color:#000; background-color: #7283a7;}
         .minor-bg{color:#000; background-color: #fbe9e7 ;}
         .minorfb-bg{color:#000; background-color: #ffccbc;}
         .minorlat-bg{color:#000; background-color: #ffab91;}
         .minorlong-bg{color:#000; background-color: #ff8a65;}
         .majorin-bg{color:#000; background-color: #efebe9;}
         .majorinfb-bg{color:#000; background-color: #d7ccc8;}
         .majorinlat-bg{color:#000; background-color: #bcaaa4;}
         .majorinlong-bg{color:#000; background-color: #a1887f ;}
         .minorin-bg{color:#000; background-color: #f9fbe7 ;}
         .minorinfb-bg{color:#000; background-color: #f0f4c3;}
         .minorinlat-bg{color:#000; background-color: #e6ee9c;}
         .minorinlong-bg{color:#000; background-color: #dce775;}
         .north-bg{color:#000; background-color: #f3e5f5;}
         .south-bg{color:#000; background-color: #e1bee7;}
         .row.vdivide [class*='col-']:not(:last-child):after {
         background: #e0e0e0;
         width: 1px;
         content: "";
         display:block;
         position: absolute;
         top:0;
         bottom: 0;
         right: 0;
         min-height: 70px;
         }
      </style>
      <style>	  
         .icon {
         max-width: 70%;
         max-height: 70%;
         margin: 4px;
         }
      </style>
      <style>
         hr.major {
         background-color: #fff;
         border-top: 2px dashed #428bca;
         }
         hr.solstice {
         background-color: #fff;
         border-top: 2px dashed #fd7e14;
         }
         hr.minor {
         background-color: #fff;
         border-top: 2px dashed #dc3545;
         }
         hr.crossquarter {
         background-color: #fff;
         border-top: 2px dashed #28a745;
         }
         hr.equinox {
         background-color: #fff;
         border-top: 2px dashed #ffc107;
         }
         hr.north {
         background-color: #fff;
         border-top: 2px dashed #dee2e6;
         }
         .modal-header-primary {
         color:#fff;
         padding:9px 15px;
         border-bottom:1px solid #eee;
         background-color: #428bca;
         -webkit-border-top-left-radius: 5px;
         -webkit-border-top-right-radius: 5px;
         -moz-border-radius-topleft: 5px;
         -moz-border-radius-topright: 5px;
         border-top-left-radius: 5px;
         border-top-right-radius: 5px;
         }
         .modal-footer{
         background-color:#f8f9fa;
         }
         .modal-dialog {
         width: 360px;
         height:400px !important;
         }
         .modal-body {
         max-height:420px !important; 
         overflow-y: auto;
         }	
         .close {
         color: #fff; 
         opacity: 1;
         }
      </style>
      <style>
		 /* Style for the calculation status message */
        #calculationStatus {
            margin-top: 15px;
            padding: 10px;
            background-color: #e0f7fa; /* Light blue background */
            color: #00796b; /* Darker blue text */
            border-radius: 4px;
            text-align: center;
            font-weight: bold;
            display: none; /* Hidden by default */
        }
		 table, th, td {
         border: 1px solid #000;
         }
         th, td {
         padding: 5px;
         }
         /* EXCLUDE adjacency matrix from max-width constraint */
         table:not(#adjacency-matrix-table) {
         max-width: 100%;
         }
         @media screen and (max-width:1767px) {
         /* EXCLUDE adjacency matrix from responsive table break */
         table:not(#adjacency-matrix-table) tr > * {
         display: block;
         }
         table:not(#adjacency-matrix-table) tr {
         display: table-cell;
         vertical-align: top;
         }
      </style>
      <style>
         .circle {
         background-color: #ff4081;
         border: 3px solid #FFF;
         border-radius: 18px;
         box-shadow: 0 0 2px #888;
         height: 30px;
         width: 30px;
         }
         .trash {
         background: rgba(255, 255, 255, 1);
         width: 33px;
         height: 33px;
         background-position: center center;
         background-size: 85%;
         background-image: url("data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiA/PjxzdmcgZGF0YS1uYW1lPSJMYXllciAxIiBpZD0iTGF5ZXJfMSIgdmlld0JveD0iMCAwIDI3MiAyNzIiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PGRlZnM+PHN0eWxlPi5jbHMtMXtmaWxsOiM0MjQyNDI7fS5jbHMtMntmaWxsOiNmZmYxNzY7fTwvc3R5bGU+PC9kZWZzPjx0aXRsZS8+PHBhdGggY2xhc3M9ImNscy0xIiBkPSJNMjEyLjgsOCw4LDIxMi44LDU5LjIsMjY0bDkuNi05LjYsNi40LTYuNCw2LjQtNi40LDYuNC02LjQsNi40LTYuNCw2LjQtNi40LDYuNC02LjQsNi40LTYuNCw2LjQtNi40LDYuNC02LjQsNi40LTYuNCw2LjQtNi40LDYuNC02LjQsNi40LTYuNCw2LjQtNi40LDYuNC02LjQsNi40LTYuNCw2LjQtNi40LDYuNC02LjQsNi40LTYuNCw2LjQtNi40LDYuNC02LjQsNi40LTYuNCw2LjQtNi40LDYuNC02LjQsNi40LTYuNCw2LjQtNi40LDYuNC02LjQsNi40LTYuNCwxNi0xNlptMjkuNTUsNjEuNTVMMjM2LDc2LDIyOC44LDY4LjhsLTYuNCw2LjQsNy4xNSw3LjE1LTYuNCw2LjRMMjE2LDgxLjYsMjA5LjYsODhsNy4xNSw3LjE1LTYuNCw2LjRMMjAzLjIsOTQuNGwtNi40LDYuNEwyMDQsMTA4bC02LjQsNi40LTcuMTUtNy4xNS02LjQsNi40LDcuMTUsNy4xNS02LjQsNi40TDE3MS4yLDExMy42bC02LjQsNi40LDEzLjU1LDEzLjU1TDE3MiwxNDBsLTcuMTUtNy4xNS02LjQsNi40LDcuMTUsNy4xNS02LjQsNi40TDE1MiwxNDUuNmwtNi40LDYuNCw3LjE1LDcuMTUtNi40LDYuNC03LjE1LTcuMTUtNi40LDYuNEwxNDAsMTcybC02LjQsNi40LTcuMTUtNy4xNS02LjQsNi40LDcuMTUsNy4xNS02LjQsNi40TDEwNy4yLDE3Ny42bC02LjQsNi40LDEzLjU1LDEzLjU1TDEwOCwyMDRsLTcuMTUtNy4xNS02LjQsNi40LDcuMTUsNy4xNS02LjQsNi40TDg4LDIwOS42LDgxLjYsMjE2bDcuMTUsNy4xNS02LjQsNi40TDc1LjIsMjIyLjRsLTYuNCw2LjRMNzYsMjM2bC02LjQsNi40TDYyLjQsMjM1LjIsNTYsMjQxLjZsNy4xNSw3LjE1LTQsMy45NEwxOS4zMSwyMTIuOCwyMTIuOCwxOS4zMSwyNTIuNjksNTkuMmwtMy45NCwzLjk1TDIzNS4yLDQ5LjYsMjI4LjgsNTZaIi8+PHJlY3QgY2xhc3M9ImNscy0yIiBoZWlnaHQ9IjEwLjExIiB0cmFuc2Zvcm09InRyYW5zbGF0ZSgtMTUyLjcyIDExNS4yNikgcm90YXRlKC00NSkiIHdpZHRoPSI5LjA1IiB4PSI1OC4yNSIgeT0iMjM2LjkyIi8+PHJlY3QgY2xhc3M9ImNscy0yIiBoZWlnaHQ9IjEwLjExIiB0cmFuc2Zvcm09InRyYW5zbGF0ZSgtMTM5LjkyIDEyMC41Nikgcm90YXRlKC00NSkiIHdpZHRoPSI5LjA1IiB4PSI3MS4wNSIgeT0iMjI0LjEyIi8+PHJlY3QgY2xhc3M9ImNscy0yIiBoZWlnaHQ9IjEwLjExIiB0cmFuc2Zvcm09InRyYW5zbGF0ZSgtMTI3LjEyIDEyNS44Nykgcm90YXRlKC00NSkiIHdpZHRoPSI5LjA1IiB4PSI4My44NSIgeT0iMjExLjMyIi8+PHJlY3QgY2xhc3M9ImNscy0yIiBoZWlnaHQ9IjEwLjExIiB0cmFuc2Zvcm09InRyYW5zbGF0ZSgtMTE0LjMyIDEzMS4xNykgcm90YXRlKC00NSkiIHdpZHRoPSI5LjA1IiB4PSI5Ni42NSIgeT0iMTk4LjUyIi8+PHJlY3QgY2xhc3M9ImNscy0yIiBoZWlnaHQ9IjE5LjE2IiB0cmFuc2Zvcm09InRyYW5zbGF0ZSgtMTAwLjE5IDEzMy4yNykgcm90YXRlKC00NSkiIHdpZHRoPSI5LjA1IiB4PSIxMDYuMjUiIHk9IjE3Ny45OSIvPjxyZWN0IGNsYXNzPSJjbHMtMiIgaGVpZ2h0PSIxMC4xMSIgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoLTg4LjcyIDE0MS43Nykgcm90YXRlKC00NSkiIHdpZHRoPSI5LjA1IiB4PSIxMjIuMjUiIHk9IjE3Mi45MiIvPjxyZWN0IGNsYXNzPSJjbHMtMiIgaGVpZ2h0PSIxMC4xMSIgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoLTc1LjkyIDE0Ny4wNykgcm90YXRlKC00NSkiIHdpZHRoPSI5LjA1IiB4PSIxMzUuMDUiIHk9IjE2MC4xMiIvPjxyZWN0IGNsYXNzPSJjbHMtMiIgaGVpZ2h0PSIxMC4xMSIgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoLTYzLjEyIDE1Mi4zNykgcm90YXRlKC00NSkiIHdpZHRoPSI5LjA1IiB4PSIxNDcuODUiIHk9IjE0Ny4zMiIvPjxyZWN0IGNsYXNzPSJjbHMtMiIgaGVpZ2h0PSIxMC4xMSIgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoLTUwLjMyIDE1Ny42OCkgcm90YXRlKC00NSkiIHdpZHRoPSI5LjA1IiB4PSIxNjAuNjUiIHk9IjEzNC41MiIvPjxyZWN0IGNsYXNzPSJjbHMtMiIgaGVpZ2h0PSIxOS4xNiIgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoLTM2LjE5IDE1OS43OCkgcm90YXRlKC00NSkiIHdpZHRoPSI5LjA1IiB4PSIxNzAuMjUiIHk9IjExMy45OSIvPjxyZWN0IGNsYXNzPSJjbHMtMiIgaGVpZ2h0PSIxMC4xMSIgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoLTI0LjcyIDE2OC4yOCkgcm90YXRlKC00NSkiIHdpZHRoPSI5LjA1IiB4PSIxODYuMjUiIHk9IjEwOC45MiIvPjxyZWN0IGNsYXNzPSJjbHMtMiIgaGVpZ2h0PSIxMC4xMSIgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoLTExLjkyIDE3My41OCkgcm90YXRlKC00NSkiIHdpZHRoPSI5LjA1IiB4PSIxOTkuMDUiIHk9Ijk2LjEyIi8+PHJlY3QgY2xhc3M9ImNscy0yIiBoZWlnaHQ9IjEwLjExIiB0cmFuc2Zvcm09InRyYW5zbGF0ZSgwLjg4IDE3OC44OCkgcm90YXRlKC00NSkiIHdpZHRoPSI5LjA1IiB4PSIyMTEuODUiIHk9IjgzLjMyIi8+PHJlY3QgY2xhc3M9ImNscy0yIiBoZWlnaHQ9IjEwLjExIiB0cmFuc2Zvcm09InRyYW5zbGF0ZSgxMy42OCAxODQuMTkpIHJvdGF0ZSgtNDUpIiB3aWR0aD0iOS4wNSIgeD0iMjI0LjY1IiB5PSI3MC41MiIvPjxyZWN0IGNsYXNzPSJjbHMtMiIgaGVpZ2h0PSIxOS4xNiIgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoMjcuODEgMTg2LjI5KSByb3RhdGUoLTQ1KSIgd2lkdGg9IjkuMDUiIHg9IjIzNC4yNSIgeT0iNDkuOTkiLz48cmVjdCBjbGFzcz0iY2xzLTEiIGhlaWdodD0iMTguMSIgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoLTE1My44OSAxMTguMDkpIHJvdGF0ZSgtNDUpIiB3aWR0aD0iOS4wNSIgeD0iNjEuMDciIHk9IjIzNS43NSIvPjxwb2x5Z29uIGNsYXNzPSJjbHMtMSIgcG9pbnRzPSI4OCAyMzUuMiA4MS42IDI0MS42IDY4LjggMjI4LjggNzUuMiAyMjIuNCA4Mi4zNSAyMjkuNTUgODggMjM1LjIiLz48cG9seWdvbiBjbGFzcz0iY2xzLTEiIHBvaW50cz0iMTAwLjggMjIyLjQgOTQuNCAyMjguOCA4OC43NSAyMjMuMTUgODEuNiAyMTYgODggMjA5LjYgMTAwLjggMjIyLjQiLz48cmVjdCBjbGFzcz0iY2xzLTEiIGhlaWdodD0iMTguMSIgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoLTExNS40OSAxMzMuOTkpIHJvdGF0ZSgtNDUpIiB3aWR0aD0iOS4wNSIgeD0iOTkuNDciIHk9IjE5Ny4zNSIvPjxyZWN0IGNsYXNzPSJjbHMtMSIgaGVpZ2h0PSIyNy4xNSIgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoLTEwMS4zNiAxMzYuMDkpIHJvdGF0ZSgtNDUpIiB3aWR0aD0iOS4wNSIgeD0iMTA5LjA3IiB5PSIxNzYuODIiLz48cmVjdCBjbGFzcz0iY2xzLTEiIGhlaWdodD0iMTguMSIgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoLTg5Ljg5IDE0NC42KSByb3RhdGUoLTQ1KSIgd2lkdGg9IjkuMDUiIHg9IjEyNS4wNyIgeT0iMTcxLjc1Ii8+PHBvbHlnb24gY2xhc3M9ImNscy0xIiBwb2ludHM9IjE1MiAxNzEuMiAxNDUuNiAxNzcuNiAxMzIuOCAxNjQuOCAxMzkuMiAxNTguNCAxNDYuMzUgMTY1LjU1IDE1MiAxNzEuMiIvPjxwb2x5Z29uIGNsYXNzPSJjbHMtMSIgcG9pbnRzPSIxNjQuOCAxNTguNCAxNTguNCAxNjQuOCAxNTIuNzUgMTU5LjE1IDE0NS42IDE1MiAxNTIgMTQ1LjYgMTY0LjggMTU4LjQiLz48cmVjdCBjbGFzcz0iY2xzLTEiIGhlaWdodD0iMTguMSIgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoLTUxLjQ5IDE2MC41KSByb3RhdGUoLTQ1KSIgd2lkdGg9IjkuMDUiIHg9IjE2My40NyIgeT0iMTMzLjM1Ii8+PHJlY3QgY2xhc3M9ImNscy0xIiBoZWlnaHQ9IjI3LjE1IiB0cmFuc2Zvcm09InRyYW5zbGF0ZSgtMzcuMzYgMTYyLjYpIHJvdGF0ZSgtNDUpIiB3aWR0aD0iOS4wNSIgeD0iMTczLjA3IiB5PSIxMTIuODIiLz48cmVjdCBjbGFzcz0iY2xzLTEiIGhlaWdodD0iMTguMSIgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoLTI1Ljg5IDE3MS4xKSByb3RhdGUoLTQ1KSIgd2lkdGg9IjkuMDUiIHg9IjE4OS4wNyIgeT0iMTA3Ljc1Ii8+PHBvbHlnb24gY2xhc3M9ImNscy0xIiBwb2ludHM9IjIxNiAxMDcuMiAyMDkuNiAxMTMuNiAxOTYuOCAxMDAuOCAyMDMuMiA5NC40IDIxMC4zNSAxMDEuNTUgMjE2IDEwNy4yIi8+PHBvbHlnb24gY2xhc3M9ImNscy0xIiBwb2ludHM9IjIyOC44IDk0LjQgMjIyLjQgMTAwLjggMjE2Ljc1IDk1LjE1IDIwOS42IDg4IDIxNiA4MS42IDIyOC44IDk0LjQiLz48cmVjdCBjbGFzcz0iY2xzLTEiIGhlaWdodD0iMTguMSIgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoMTIuNTEgMTg3LjAxKSByb3RhdGUoLTQ1KSIgd2lkdGg9IjkuMDUiIHg9IjIyNy40NyIgeT0iNjkuMzUiLz48cmVjdCBjbGFzcz0iY2xzLTEiIGhlaWdodD0iMjcuMTUiIHRyYW5zZm9ybT0idHJhbnNsYXRlKDI2LjY0IDE4OS4xMSkgcm90YXRlKC00NSkiIHdpZHRoPSI5LjA1IiB4PSIyMzcuMDciIHk9IjQ4LjgyIi8+PC9zdmc+");
         background-repeat: no-repeat;
         }
         .trash2 {
         background: rgba(255, 255, 255, 1);
         width: 33px;
         height: 33px;
         background-position: center center;
         background-size: 85%;
         background-image: url("data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiA/PjxzdmcgZGF0YS1uYW1lPSJMYXllciAxIiBpZD0iTGF5ZXJfMSIgdmlld0JveD0iMCAwIDI3MiAyNzIiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PGRlZnM+PHN0eWxlPi5jbHMtMXtmaWxsOiM0MjQyNDI7fS5jbHMtMntmaWxsOiNmZmYxNzY7fTwvc3R5bGU+PC9kZWZzPjx0aXRsZS8+PHBhdGggY2xhc3M9ImNscy0xIiBkPSJNMjEyLjgsOCw4LDIxMi44LDU5LjIsMjY0bDkuNi05LjYsNi40LTYuNCw2LjQtNi40LDYuNC02LjQsNi40LTYuNCw2LjQtNi40LDYuNC02LjQsNi40LTYuNCw2LjQtNi40LDYuNC02LjQsNi40LTYuNCw2LjQtNi40LDYuNC02LjQsNi40LTYuNCw2LjQtNi40LDYuNC02LjQsNi40LTYuNCw2LjQtNi40LDYuNC02LjQsNi40LTYuNCw2LjQtNi40LDYuNC02LjQsNi40LTYuNCw2LjQtNi40LDYuNC02LjQsNi40LTYuNCw2LjQtNi40LDYuNC02LjQsNi40LTYuNCwxNi0xNlptMjkuNTUsNjEuNTVMMjM2LDc2LDIyOC44LDY4LjhsLTYuNCw2LjQsNy4xNSw3LjE1LTYuNCw2LjRMMjE2LDgxLjYsMjA5LjYsODhsNy4xNSw3LjE1LTYuNCw2LjRMMjAzLjIsOTQuNGwtNi40LDYuNEwyMDQsMTA4bC02LjQsNi40LTcuMTUtNy4xNS02LjQsNi40LDcuMTUsNy4xNS02LjQsNi40TDE3MS4yLDExMy42bC02LjQsNi40LDEzLjU1LDEzLjU1TDE3MiwxNDBsLTcuMTUtNy4xNS02LjQsNi40LDcuMTUsNy4xNS02LjQsNi40TDE1MiwxNDUuNmwtNi40LDYuNCw3LjE1LDcuMTUtNi40LDYuNC03LjE1LTcuMTUtNi40LDYuNEwxNDAsMTcybC02LjQsNi40LTcuMTUtNy4xNS02LjQsNi40LDcuMTUsNy4xNS02LjQsNi40TDEwNy4yLDE3Ny42bC02LjQsNi40LDEzLjU1LDEzLjU1TDEwOCwyMDRsLTcuMTUtNy4xNS02LjQsNi40LDcuMTUsNy4xNS02LjQsNi40TDg4LDIwOS42LDgxLjYsMjE2bDcuMTUsNy4xNS02LjQsNi40TDc1LjIsMjIyLjRsLTYuNCw2LjRMNzYsMjM2bC02LjQsNi40TDYyLjQsMjM1LjIsNTYsMjQxLjZsNy4xNSw3LjE1LTQsMy45NEwxOS4zMSwyMTIuOCwyMTIuOCwxOS4zMSwyNTIuNjksNTkuMmwtMy45NCwzLjk1TDIzNS4yLDQ5LjYsMjI4LjgsNTZaIi8+PHJlY3QgY2xhc3M9ImNscy0yIiBoZWlnaHQ9IjEwLjExIiB0cmFuc2Zvcm09InRyYW5zbGF0ZSgtMTUyLjcyIDExNS4yNikgcm90YXRlKC00NSkiIHdpZHRoPSI5LjA1IiB4PSI1OC4yNSIgeT0iMjM2LjkyIi8+PHJlY3QgY2xhc3M9ImNscy0yIiBoZWlnaHQ9IjEwLjExIiB0cmFuc2Zvcm09InRyYW5zbGF0ZSgtMTM5LjkyIDEyMC41Nikgcm90YXRlKC00NSkiIHdpZHRoPSI5LjA1IiB4PSI3MS4wNSIgeT0iMjI0LjEyIi8+PHJlY3QgY2xhc3M9ImNscy0yIiBoZWlnaHQ9IjEwLjExIiB0cmFuc2Zvcm09InRyYW5zbGF0ZSgtMTI3LjEyIDEyNS44Nykgcm90YXRlKC00NSkiIHdpZHRoPSI5LjA1IiB4PSI4My44NSIgeT0iMjExLjMyIi8+PHJlY3QgY2xhc3M9ImNscy0yIiBoZWlnaHQ9IjEwLjExIiB0cmFuc2Zvcm09InRyYW5zbGF0ZSgtMTE0LjMyIDEzMS4xNykgcm90YXRlKC00NSkiIHdpZHRoPSI5LjA1IiB4PSI5Ni42NSIgeT0iMTk4LjUyIi8+PHJlY3QgY2xhc3M9ImNscy0yIiBoZWlnaHQ9IjE5LjE2IiB0cmFuc2Zvcm09InRyYW5zbGF0ZSgtMTAwLjE5IDEzMy4yNykgcm90YXRlKC00NSkiIHdpZHRoPSI5LjA1IiB4PSIxMDYuMjUiIHk9IjE3Ny45OSIvPjxyZWN0IGNsYXNzPSJjbHMtMiIgaGVpZ2h0PSIxMC4xMSIgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoLTg4LjcyIDE0MS43Nykgcm90YXRlKC00NSkiIHdpZHRoPSI5LjA1IiB4PSIxMjIuMjUiIHk9IjE3Mi45MiIvPjxyZWN0IGNsYXNzPSJjbHMtMiIgaGVpZ2h0PSIxMC4xMSIgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoLTc1LjkyIDE0Ny4wNykgcm90YXRlKC00NSkiIHdpZHRoPSI5LjA1IiB4PSIxMzUuMDUiIHk9IjE2MC4xMiIvPjxyZWN0IGNsYXNzPSJjbHMtMiIgaGVpZ2h0PSIxMC4xMSIgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoLTYzLjEyIDE1Mi4zNykgcm90YXRlKC00NSkiIHdpZHRoPSI5LjA1IiB4PSIxNDcuODUiIHk9IjE0Ny4zMiIvPjxyZWN0IGNsYXNzPSJjbHMtMiIgaGVpZ2h0PSIxMC4xMSIgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoLTUwLjMyIDE1Ny42OCkgcm90YXRlKC00NSkiIHdpZHRoPSI5LjA1IiB4PSIxNjAuNjUiIHk9IjEzNC41MiIvPjxyZWN0IGNsYXNzPSJjbHMtMiIgaGVpZ2h0PSIxOS4xNiIgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoLTM2LjE5IDE1OS43OCkgcm90YXRlKC00NSkiIHdpZHRoPSI5LjA1IiB4PSIxNzAuMjUiIHk9IjExMy45OSIvPjxyZWN0IGNsYXNzPSJjbHMtMiIgaGVpZ2h0PSIxMC4xMSIgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoLTI0LjcyIDE2OC4yOCkgcm90YXRlKC00NSkiIHdpZHRoPSI5LjA1IiB4PSIxODYuMjUiIHk9IjEwOC45MiIvPjxyZWN0IGNsYXNzPSJjbHMtMiIgaGVpZ2h0PSIxMC4xMSIgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoLTExLjkyIDE3My41OCkgcm90YXRlKC00NSkiIHdpZHRoPSI5LjA1IiB4PSIxOTkuMDUiIHk9Ijk2LjEyIi8+PHJlY3QgY2xhc3M9ImNscy0yIiBoZWlnaHQ9IjEwLjExIiB0cmFuc2Zvcm09InRyYW5zbGF0ZSgwLjg4IDE3OC44OCkgcm90YXRlKC00NSkiIHdpZHRoPSI5LjA1IiB4PSIyMTEuODUiIHk9IjgzLjMyIi8+PHJlY3QgY2xhc3M9ImNscy0yIiBoZWlnaHQ9IjEwLjExIiB0cmFuc2Zvcm09InRyYW5zbGF0ZSgxMy42OCAxODQuMTkpIHJvdGF0ZSgtNDUpIiB3aWR0aD0iOS4wNSIgeD0iMjI0LjY1IiB5PSI3MC41MiIvPjxyZWN0IGNsYXNzPSJjbHMtMiIgaGVpZ2h0PSIxOS4xNiIgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoMjcuODEgMTg2LjI5KSByb3RhdGUoLTQ1KSIgd2lkdGg9IjkuMDUiIHg9IjIzNC4yNSIgeT0iNDkuOTkiLz48cmVjdCBjbGFzcz0iY2xzLTEiIGhlaWdodD0iMTguMSIgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoLTE1My44OSAxMTguMDkpIHJvdGF0ZSgtNDUpIiB3aWR0aD0iOS4wNSIgeD0iNjEuMDciIHk9IjIzNS43NSIvPjxwb2x5Z29uIGNsYXNzPSJjbHMtMSIgcG9pbnRzPSI4OCAyMzUuMiA4MS42IDI0MS42IDY4LjggMjI4LjggNzUuMiAyMjIuNCA4Mi4zNSAyMjkuNTUgODggMjM1LjIiLz48cG9seWdvbiBjbGFzcz0iY2xzLTEiIHBvaW50cz0iMTAwLjggMjIyLjQgOTQuNCAyMjguOCA4OC43NSAyMjMuMTUgODEuNiAyMTYgODggMjA5LjYgMTAwLjggMjIyLjQiLz48cmVjdCBjbGFzcz0iY2xzLTEiIGhlaWdodD0iMTguMSIgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoLTExNS40OSAxMzMuOTkpIHJvdGF0ZSgtNDUpIiB3aWR0aD0iOS4wNSIgeD0iOTkuNDciIHk9IjE5Ny4zNSIvPjxyZWN0IGNsYXNzPSJjbHMtMSIgaGVpZ2h0PSIyNy4xNSIgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoLTEwMS4zNiAxMzYuMDkpIHJvdGF0ZSgtNDUpIiB3aWR0aD0iOS4wNSIgeD0iMTA5LjA3IiB5PSIxNzYuODIiLz48cmVjdCBjbGFzcz0iY2xzLTEiIGhlaWdodD0iMTguMSIgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoLTg5Ljg5IDE0NC42KSByb3RhdGUoLTQ1KSIgd2lkdGg9IjkuMDUiIHg9IjEyNS4wNyIgeT0iMTcxLjc1Ii8+PHBvbHlnb24gY2xhc3M9ImNscy0xIiBwb2ludHM9IjE1MiAxNzEuMiAxNDUuNiAxNzcuNiAxMzIuOCAxNjQuOCAxMzkuMiAxNTguNCAxNDYuMzUgMTY1LjU1IDE1MiAxNzEuMiIvPjxwb2x5Z29uIGNsYXNzPSJjbHMtMSIgcG9pbnRzPSIxNjQuOCAxNTguNCAxNTguNCAxNjQuOCAxNTIuNzUgMTU5LjE1IDE0NS42IDE1MiAxNTIgMTQ1LjYgMTY0LjggMTU4LjQiLz48cmVjdCBjbGFzcz0iY2xzLTEiIGhlaWdodD0iMTguMSIgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoLTUxLjQ5IDE2MC41KSByb3RhdGUoLTQ1KSIgd2lkdGg9IjkuMDUiIHg9IjE2My40NyIgeT0iMTMzLjM1Ii8+PHJlY3QgY2xhc3M9ImNscy0xIiBoZWlnaHQ9IjI3LjE1IiB0cmFuc2Zvcm09InRyYW5zbGF0ZSgtMzcuMzYgMTYyLjYpIHJvdGF0ZSgtNDUpIiB3aWR0aD0iOS4wNSIgeD0iMTczLjA3IiB5PSIxMTIuODIiLz48cmVjdCBjbGFzcz0iY2xzLTEiIGhlaWdodD0iMTguMSIgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoLTI1Ljg5IDE3MS4xKSByb3RhdGUoLTQ1KSIgd2lkdGg9IjkuMDUiIHg9IjE4OS4wNyIgeT0iMTA3Ljc1Ii8+PHBvbHlnb24gY2xhc3M9ImNscy0xIiBwb2ludHM9IjIxNiAxMDcuMiAyMDkuNiAxMTMuNiAxOTYuOCAxMDAuOCAyMDMuMiA5NC40IDIxMC4zNSAxMDEuNTUgMjE2IDEwNy4yIi8+PHBvbHlnb24gY2xhc3M9ImNscy0xIiBwb2ludHM9IjIyOC44IDk0LjQgMjIyLjQgMTAwLjggMjE2Ljc1IDk1LjE1IDIwOS42IDg4IDIxNiA4MS42IDIyOC44IDk0LjQiLz48cmVjdCBjbGFzcz0iY2xzLTEiIGhlaWdodD0iMTguMSIgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoMTIuNTEgMTg3LjAxKSByb3RhdGUoLTQ1KSIgd2lkdGg9IjkuMDUiIHg9IjIyNy40NyIgeT0iNjkuMzUiLz48cmVjdCBjbGFzcz0iY2xzLTEiIGhlaWdodD0iMjcuMTUiIHRyYW5zZm9ybT0idHJhbnNsYXRlKDI2LjY0IDE4OS4xMSkgcm90YXRlKC00NSkiIHdpZHRoPSI5LjA1IiB4PSIyMzcuMDciIHk9IjQ4LjgyIi8+PC9zdmc+");
         background-repeat: no-repeat;
         }
      </style>
      <style>
         .leaflet-popup-content-wrapper {
         background: #FFFFFF;
         border-radius: 2px;
         }
         .leaflet-popup {
         position: absolute;
         text-align: center;
         }
         .leaflet-popup-content {
         margin-top: 20px;
         margin-right: 2px;
         padding-right: 12px;
         min-width: 100 px !important;
         max-height: 300px;
         overflow: auto;
         }
      </style>
      <style>
         }
         .drag-area {
         border: 2px dashed #ced4da; /* Bootstrap's default border color */
         background-color: #f8f9fa; /* Bootstrap's light background */
         min-height: 120px;
         display: flex;
         align-items: center;
         justify-content: center;
         text-align: center;
         border-radius: 0.25rem; /* Bootstrap's rounded-3 */
         transition: background-color 0.3s ease;
         margin-bottom: 15px; /* Equivalent to mb-3 */
         padding: 15px; /* Equivalent to p-4 */
         }
         .drag-area.highlight {
         background-color: #e9ecef; /* Lighter background for highlight */
         }
         /* Custom scrollbar for image list */
         #image-list-container {
         max-height: calc(100vh - 400px); /* Adjust based on other elements' height */
         overflow-y: auto;
         scrollbar-width: thin; /* Firefox */
         scrollbar-color: #6c757d #f8f9fa; /* Bootstrap's secondary/light colors */
         border: 1px solid #ddd; /* Equivalent to border border-secondary-subtle */
         border-radius: 4px; /* Equivalent to rounded */
         background-color: #f8f9fa; /* Equivalent to bg-light */
         padding: 15px; /* Equivalent to p-3 */
         }
         #image-list-container::-webkit-scrollbar {
         width: 8px;
         }
         #image-list-container::-webkit-scrollbar-track {
         background: #f8f9fa; /* track color */
         border-radius: 4px;
         }
         #image-list-container::-webkit-scrollbar-thumb {
         background-color: #6c757d; /* thumb color */
         border-radius: 44px;
         border: 2px solid #f8f9fa; /* creates padding around thumb */
         }
         /* Progress bar styles - adapted to Bootstrap's default appearance */
         .progress-container {
         width: 100%;
         background-color: #e9ecef; /* Bootstrap's lighter background for progress */
         border-radius: 0.5rem; /* rounded-pill */
         height: 1.25rem; /* h-5 */
         overflow: hidden;
         margin-top: 1rem; /* mt-4 */
         border: 1px solid #dee2e6; /* Bootstrap's border color */
         margin-bottom: 15px; /* Equivalent to mb-3 */
         }
         .progress-bar {
         height: 100%;
         width: 0%;
         background-color: #0d6efd; /* Bootstrap's primary blue */
         border-radius: 0.5rem; /* rounded-pill */
         text-align: center;
         color: white;
         line-height: 1.25rem; /* center text vertically */
         font-size: 0.75rem; /* text-xs */
         transition: width 0.3s ease-in-out;
         display: flex;
         align-items: center;
         justify-content: center;
         }
         /* NEW: CSS to hide any appended canvas/img element, assuming it's placed directly below body. */
         /* This is a workaround for the library's default behavior. */
         body > canvas, body > img {
         display: none !important;
         height: 0 !important;
         width: 0 !important;
         overflow: hidden !important;
         visibility: hidden !important;
         }
         /* Custom styles for Bootstrap 3 compatibility */
         .panel { /* Replaced common Bootstrap 5 `bg-white p-4 rounded shadow-sm d-flex flex-column overflow-auto` */
         background-color: #fff;
         border: 1px solid #ddd;
         border-radius: 4px;
         box-shadow: 0 1px 1px rgba(0,0,0,.05);
         margin-bottom: 20px;
         overflow: auto; /* For `overflow-auto` effect */
         }
         .panel-body {
         padding: 15px;
         }
         .h3-custom {
         font-size: 24px; /* Equivalent to Bootstrap 3's h3 */
         font-weight: bold; /* Equivalent to fw-bold */
         margin-top: 0;
         margin-bottom: 10px; /* Equivalent to mb-4 */
         color: #333; /* Equivalent to text-dark */
         }
         .h5-custom {
         font-size: 14px; /* Equivalent to Bootstrap 3's h5 */
         font-weight: bold; /* Equivalent to fw-semibold, Bootstrap 3 default h5 is bold */
         margin-top: 10px;
         margin-bottom: 10px; /* Equivalent to mb-3 */
         color: #6c757d; /* Similar to text-secondary */
         }
         .form-group-custom {
         margin-bottom: 15px; /* Equivalent to mb-3 */
         margin-top: 15px; /* Equivalent to mt-3 */
         }
         .input-group-custom {
         position: relative;
         display: table;
         border-collapse: separate;
         }
         .input-group-custom .form-control {
         display: table-cell;
         }
         .input-group-btn-custom {
         display: table-cell;
         white-space: nowrap;
         width: 1%;
         vertical-align: middle;
         }
         .input-group-btn-custom .btn {
         height: 34px; /* Default Bootstrap 3 input height */
         }
         .text-small-custom {
         font-size: 85%; /* Equivalent to small */
         color: #999; /* Equivalent to text-muted */
         margin-top: 5px; /* Equivalent to mt-2 */
         }
         .table-condensed > thead > tr > th,
         .table-condensed > tbody > tr > th,
         .table-condensed > tfoot > tr > th,
         .table-condensed > thead > tr > td,
         .table-condensed > tbody > tr > td,
         .table-condensed > tfoot > tr > td {
         padding: 5px; /* Custom padding for table cells, as px-2 py-2 are not in BS3 */
         }
         .table-white-bg > tbody {
         background-color: #fff; /* Equivalent to bg-white for tbody */
         }
         .full-width-btn {
         width: 100%;
         margin-top: 15px; /* Equivalent to mt-3 */
         }
         /* Info/Help Link Styles */
         .panel-help-link {
            display: flex;
            align-items: center;
            justify-content: flex-end;
            gap: 6px;
            margin-bottom: 10px;
            cursor: pointer;
            text-decoration: none;
         }
         .panel-help-link:hover {
            text-decoration: none;
         }
         .panel-help-link i {
            font-size: 14px;
            color: #ff8c00;
         }
         .panel-help-link span {
            font-size: 12px;
            color: #555;
         }
         /* Collapsible Help Section */
         .panel-help-content {
            display: none;
            padding: 12px 15px;
            background: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
            font-size: 12px;
            line-height: 1.6;
            color: #495057;
         }
         .panel-help-content.show {
            display: block;
         }
         .panel-help-content h5 {
            margin-top: 0;
            margin-bottom: 8px;
            color: #007bff;
            font-size: 13px;
            font-weight: bold;
         }
         .panel-help-content ul {
            margin: 8px 0;
            padding-left: 20px;
         }
         .panel-help-content li {
            margin: 4px 0;
         }
         .panel-help-content code {
            background: #e9ecef;
            padding: 2px 4px;
            border-radius: 2px;
            font-size: 11px;
         }
         /* Horizon Results Panel Styles */
         .chart-container { 
            height: 150px; 
            width: 100%; 
            position: relative; 
            margin-bottom: 15px; 
            border: 1px solid #ddd; 
         }
         .pano-container { 
            height: 200px; 
            width: 100%; 
            position: relative; 
            border: 1px solid #999; 
            margin-bottom: 15px; 
            overflow: auto;
            overflow-y: scroll;
            overflow-x: hidden;
         }
         canvas.interactive { 
            cursor: move; 
            width: 100%; 
            height: auto; 
            min-height: 100%;
            display: block; 
         }
         /* Nav Arrows */
         .nav-arrow {
            position: absolute; 
            top: 0; 
            bottom: 0; 
            width: 30px;
            background: rgba(0,0,0,0.05); 
            color: #333;
            display: flex; 
            align-items: center; 
            justify-content: center;
            cursor: pointer; 
            font-weight: bold; 
            font-size: 18px;
            z-index: 20; 
            user-select: none;
         }
         .nav-arrow:hover { 
            background: rgba(0,0,0,0.2); 
            color: white; 
         }
         .nav-left { 
            left: 0; 
         }
         .nav-right { 
            right: 0; 
         }
         .section-title { 
            font-weight: bold; 
            margin-bottom: 5px; 
            border-bottom: 1px solid #eee; 
            padding-bottom: 5px; 
         }
         /* Horizon Results Panel - Bottom of page, full width, above map */
         #hc-results-panel {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            width: 100%;
            z-index: 900;
            background: rgba(255,255,255,0.98);
            box-shadow: none;
            border: none;
            display: none; 
            height: 50vh; 
            max-height: 70vh;
            flex-direction: column; 
            margin-bottom: 0;
            border-radius: 0;
            transition: height 0.3s;
         }
         #hc-results-panel.expanded { height: 70vh; }
         #hc-results-panel.minimized { height: 40px; overflow: hidden; }
         #hc-results-panel .panel-heading { 
            cursor: pointer; 
            user-select: none; 
            flex: 0 0 auto; 
            background-color: var(--ai-green) !important; 
            text-align: left;
            position: relative;
            padding: 8px 15px;
         }
         #hc-results-panel .panel-heading .panel-title {
            color: #FFFFFF !important;
            font-size: 14.4pt;
            text-align: left;
            margin: 0;
            padding: 0;
         }
         #hc-results-panel .panel-heading .btn-group {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
         }
         #hc-results-panel .panel-heading .btn-group .btn {
            background-color: #ffffff !important;
            color: #333333 !important;
            border: none !important;
            box-shadow: none !important;
            outline: none !important;
            padding: 4px 8px;
         }
         #hc-results-panel .panel-heading .btn-group .btn:hover {
            background-color: #f0f0f0 !important;
            color: #333333 !important;
            border: none !important;
            box-shadow: none !important;
         }
         #hc-results-panel .panel-heading .btn-group .btn:focus,
         #hc-results-panel .panel-heading .btn-group .btn:active {
            background-color: #e0e0e0 !important;
            color: #333333 !important;
            border: none !important;
            box-shadow: none !important;
            outline: none !important;
         }
         #hc-results-panel .panel-body { padding: 15px; overflow-y: auto; flex: 1 1 auto; min-height: 0; }
         
         /* Intervisibility Statistics Panel - Bottom of page, full width, above map (same as Horizon Results) */
         #iv-results-panel {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            width: 100%;
            z-index: 1000;
            background-color: #ffffff;
            border-top: 2px solid #ddd;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column; 
            margin-bottom: 0;
            border-radius: 0;
            transition: height 0.3s;
         }
         #iv-results-panel.expanded { height: 70vh; }
         #iv-results-panel.minimized { height: 40px; overflow: hidden; }
         #iv-results-panel .panel-heading { 
            cursor: pointer; 
            user-select: none; 
            flex: 0 0 auto; 
            background-color: var(--ai-green) !important; 
            text-align: left;
            position: relative;
            padding: 8px 15px;
         }
         #iv-results-panel .panel-heading .panel-title {
            color: #FFFFFF !important;
            font-size: 14.4pt;
            text-align: left;
            margin: 0;
            padding: 0;
         }
         #iv-results-panel .panel-heading .btn-group {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
         }
         #iv-results-panel .panel-heading .btn-group .btn {
            background-color: #ffffff !important;
            color: #333333 !important;
            border: none !important;
            box-shadow: none !important;
            outline: none !important;
            padding: 4px 8px;
         }
         #iv-results-panel .panel-heading .btn-group .btn:hover {
            background-color: #f0f0f0 !important;
            color: #333333 !important;
            border: none !important;
            box-shadow: none !important;
         }
         #iv-results-panel .panel-heading .btn-group .btn:focus,
         #iv-results-panel .panel-heading .btn-group .btn:active {
            background-color: #e0e0e0 !important;
            color: #333333 !important;
            border: none !important;
            box-shadow: none !important;
            outline: none !important;
         }
         /* CRITICAL FIX: Override .panel overflow for iv-results-panel to allow horizontal scrolling */
         #iv-results-panel.panel {
            overflow-x: visible !important;
            overflow-y: auto !important;
         }
         #iv-results-panel .panel-body { 
            padding: 15px; 
            overflow-y: auto !important; 
            overflow-x: visible !important;
            flex: 1 1 auto; 
            min-height: 0; 
         }
         
         /* COMPREHENSIVE FIX: Override ALL global table styles for adjacency matrix */
         #adjacency-matrix-wrapper {
            overflow-x: scroll !important;
            overflow-y: auto !important;
            /* Width will be set by JavaScript to parent's width */
            position: relative !important;
            display: block !important;
            box-sizing: border-box !important;
            /* CRITICAL: Prevent wrapper from expanding with content */
            min-width: 0 !important;
            max-width: 100% !important;
            /* CRITICAL: Force scrollbars to be visible (override global scrollbar.css) */
            scrollbar-width: auto !important; /* Firefox */
            scrollbar-color: #1c2a48 rgba(204,204,204,0.8) !important; /* Firefox */
         }
         /* CRITICAL: Override global scrollbar.css that hides horizontal scrollbars */
         #adjacency-matrix-wrapper::-webkit-scrollbar {
            width: 7px !important;
            height: 7px !important; /* CRITICAL: Must be non-zero for horizontal scrollbar */
         }
         #adjacency-matrix-wrapper::-webkit-scrollbar-track {
            background: rgba(204,204,204,0.8) !important;
            border-radius: 0px !important;
         }
         #adjacency-matrix-wrapper::-webkit-scrollbar-thumb {
            background: #1c2a48 !important;
            border-radius: 0px !important;
         }
         #adjacency-matrix-wrapper::-webkit-scrollbar-thumb:hover {
            background: #2a3a5a !important;
         }
         #adjacency-matrix-container {
            display: inline-block !important;
            width: auto !important;
            min-width: 100% !important;
            box-sizing: content-box !important;
         }
         #adjacency-matrix-table {
            max-width: none !important;
            /* width explicitly set by JavaScript inline style - do not override with CSS */
            border-collapse: separate !important;
            display: table !important;
            table-layout: fixed !important;
            width: auto !important;
            min-width: 100% !important;
            box-sizing: content-box !important;
         }
         #adjacency-matrix-table tr {
            display: table-row !important;
         }
         #adjacency-matrix-table th,
         #adjacency-matrix-table td {
            display: table-cell !important;
            box-sizing: border-box !important;
         }
         /* CRITICAL: Ensure parent containers don't constrain width - allow horizontal overflow */
         #iv-results-panel .panel-body .row {
            width: 100% !important;
            max-width: 100% !important;
            overflow-x: visible !important;
            overflow-y: visible !important;
            box-sizing: border-box !important;
         }
         #iv-results-panel .panel-body .col-md-12 {
            width: 100% !important;
            max-width: 100% !important;
            overflow-x: visible !important;
            overflow-y: visible !important;
            position: relative !important;
            box-sizing: border-box !important;
            /* CRITICAL: Prevent flexbox from constraining */
            flex: 0 1 auto !important;
         }
         /* CRITICAL: Override media query that breaks table layout */
         @media screen and (max-width:1767px) {
            #adjacency-matrix-table tr > * {
               display: table-cell !important;
            }
            #adjacency-matrix-table tr {
               display: table-row !important;
            }
            /* Ensure wrapper still scrolls in media query */
            #adjacency-matrix-wrapper {
               overflow-x: scroll !important;
            }
         }
         /* CRITICAL: Fix sticky column positioning and z-index */
         #adjacency-matrix-table thead th:first-child,
         #adjacency-matrix-table tbody td:first-child {
            position: sticky !important;
            left: 0 !important;
            z-index: 10 !important;
         }
         #adjacency-matrix-table thead th:first-child {
            z-index: 11 !important;
         }
         
         /* Gazetteer Controls - Above map */
         #hc-gazetteer-controls {
            position: fixed; 
            top: 340px; 
            right: 20px; 
            width: 450px; 
            z-index: 1001;
            background: #fff; 
            padding: 10px; 
            border-radius: 4px; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            display: none; 
            border-left: 5px solid #f0ad4e;
         }
         #hc-gazetteer-controls h5 { cursor: move; }
         
         /* Stellarium Export Panel - Above map */
         #hc-stellarium-export-panel {
            position: fixed; 
            top: 100px; 
            right: 20px; 
            width: 350px;
            z-index: 1002;
            background: #fff; 
            padding: 0; 
            border-radius: 4px; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            display: none; 
            border-left: 5px solid #f0ad4e;
         }
         #hc-stellarium-export-panel h5 { 
            cursor: move; 
            margin-top: 0; 
            padding: 10px; 
            background-color: #f5f5f5; 
            border-bottom: 1px solid #ddd; 
         }
         #hc-gaz-table-body tr { cursor: default; }
         #hc-gaz-table-body td { vertical-align: middle; }
         #hc-gaz-table-body input { padding: 2px 4px; font-size: 11px; }
         .hc-gaz-bump-controls { display: inline-flex; align-items: center; gap: 2px; }
         .hc-gaz-bump-controls .btn-xs { padding: 1px 4px; font-size: 10px; line-height: 1.2; }
         .cursor-crosshair { cursor: crosshair !important; }
         /* Ensure Leaflet distortable image toolbar is visible above other elements */
         .leaflet-toolbar, .leaflet-toolbar-list, .ldi .leaflet-toolbar, .leaflet-popup-toolbar {
            z-index: 2000 !important;
         }
         .probe-icon {
            background-color: #E056FD; 
            border: 1px solid #E0E0E0; 
            border-radius: 50%; 
            box-sizing: border-box;
            box-shadow: 0 1px 3px rgba(0,0,0,0.5);
         }
         .gazetteer-marker {
            cursor: move;
         }
         .checkbox-group { margin-left: 20px; }
         .leaflet-popup-content { margin: 10px; line-height: 1.4; font-size: 13px; }
         .popup-btn { margin-top: 8px; }
         
         /* Drawing Tools Styles */
         .description-text { color: #777; line-height: 1.6; font-size: 14px; }
         .stats-box { background: #f9f9f9; border-radius: 4px; padding: 15px; margin-top: 15px; border: 1px solid #e3e3e3; }
         .stat-item { display: flex; justify-content: space-between; margin-bottom: 5px; }
         .stat-value { font-weight: bold; color: #333; }
         .tool-btn { 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center; 
            padding: 6px 4px;
            background-color: #fff; 
            border: 1px solid #ddd; 
            border-radius: 4px; 
            cursor: pointer; 
            transition: all 0.2s; 
            color: #555; 
            font-size: 12px;
            margin-bottom: 8px;
            height: 60px;
         }
         .tool-btn i { 
            font-size: 18px;
            margin-bottom: 4px;
            color: #337ab7; 
         }
         .tool-btn:hover { background-color: #e6f0f9; border-color: #337ab7; text-decoration: none; }
         .tool-btn.active { background-color: #337ab7; color: white; border-color: #2e6da4; box-shadow: inset 0 3px 5px rgba(0,0,0,.125); }
         .tool-btn.active i { color: white; }
         .tool-section-title { 
            font-size: 15px;
            font-weight: bold; 
            color: #777; 
            margin: 20px 0 10px 0; 
            text-transform: uppercase; 
            letter-spacing: 0.5px; 
            border-bottom: 1px solid #eee;
            padding-bottom: 5px;
         }
         input[type="color"] { -webkit-appearance: none; border: none; width: 100%; height: 34px; cursor: pointer; padding: 0; background: none; }
         input[type="color"]::-webkit-color-swatch-wrapper { padding: 0; }
         input[type="color"]::-webkit-color-swatch { border: 1px solid #ccc; border-radius: 4px; }
         .style-panel { margin-bottom: 15px; border: 1px solid #ddd; border-radius: 4px; overflow: hidden; }
         .style-panel summary { background-color: #f5f5f5; padding: 10px 15px; cursor: pointer; font-weight: bold; color: #333; outline: none; border-bottom: 1px solid #ddd; font-size: 15px; }
         .style-panel summary::-webkit-details-marker { display: none; }
         .style-panel summary::after { content: '\f078'; font-family: "FontAwesome"; float: right; font-size: 12px; color: #777; margin-top: 3px; }
         .style-panel details[open] summary::after { content: '\f077'; }
         .style-panel .panel-body { padding: 15px; border-top: 0; }
         /* Palette Table */
         .palette-item { margin-bottom: 10px; border-bottom: 1px solid #eee; padding-bottom: 10px; }
         .palette-row { display: flex; align-items: center; margin-bottom: 5px; background: #f9f9f9; padding: 4px; border-radius: 3px; }
         .palette-row input[type="number"] { width: 70px; margin-right: 5px; }
         .palette-row input[type="color"] { flex: 1; height: 30px; padding: 0; border: none; margin-right: 5px; cursor: pointer; }
         .palette-row input[type="text"] { width: 65px; font-family: monospace; font-size: 11px; margin-right: 5px;}
         .palette-btn-remove { color: #c9302c; cursor: pointer; padding: 0 8px; }
         .palette-btn-mix { cursor: pointer; color: #337ab7; margin-right: 5px; font-size: 12px; }
         
         /* Mixer UI */
         .palette-mixer { 
            display: none; 
            background: #f0f0f0; 
            padding: 8px; 
            border-radius: 4px; 
            margin-top: 5px; 
            border: 1px solid #ddd;
         }
         .palette-mixer.active { display: block; }
         .mixer-controls { display: flex; align-items: center; justify-content: space-between; margin-bottom: 5px; }
         .mixer-controls input[type="color"] { width: 30px; height: 30px; border: none; padding: 0; cursor: pointer; }
         .mixer-slider { flex: 1; margin: 0 10px; }
         
         /* Quick Swatches */
         .swatch-container { display: flex; gap: 2px; }
         .quick-swatch { width: 15px; height: 30px; cursor: pointer; border: 1px solid #ccc; opacity: 0.8; }
         .quick-swatch:hover { opacity: 1; border-color: #000; transform: scale(1.1); z-index: 10; }
         
         /* Gradient Preview */
         #hc-gradient-preview {
            width: 100%; height: 20px; border-radius: 3px; border: 1px solid #ccc; margin-bottom: 15px;
         }
         .color-swatch { width: 24px; height: 24px; border-radius: 3px; cursor: pointer; border: 1px solid rgba(0,0,0,0.1); transition: transform 0.1s; }
         .color-swatch:hover { transform: scale(1.15); border-color: #666; z-index: 2; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
         .picker-label { 
            font-size: 1.1rem;
            color: #666; 
            margin-bottom: 6px; 
            display: block;
            font-weight: 500;
         }
         .text-label-icon { background: none !important; border: none !important; width: auto !important; height: auto !important; }
         .text-label-content { font-size: 16px; font-weight: 800; white-space: nowrap; text-shadow: -1px -1px 0 #fff, 1px -1px 0 #fff, -1px 1px 0 #fff, 1px 1px 0 #fff; font-family: 'Helvetica Neue', Arial, sans-serif; cursor: pointer; }
         .cursor-crosshair { cursor: crosshair !important; }
         .leaflet-draw-tooltip { z-index: 2000; }
         #modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2999; }
         .custom-modal { display: none; position: fixed; top: 15%; left: 50%; transform: translateX(-50%); background: white; border-radius: 6px; box-shadow: 0 5px 15px rgba(0,0,0,.5); z-index: 3000; width: 300px; border: 1px solid rgba(0,0,0,.2); }
         .custom-modal-header { padding: 15px; border-bottom: 1px solid #e5e5e5; }
         .custom-modal-header h3 { margin: 0; font-size: 18px; color: #333; }
         .custom-modal-body { padding: 15px; }
         .custom-modal-footer { padding: 15px; text-align: right; border-top: 1px solid #e5e5e5; }
         .mt-10 { margin-top: 10px; }
         .mb-10 { margin-bottom: 10px; }
      </style>
      <div class='custom-popup' id='map'></div>
   </head>
   <body onload="compute(); latlongChanged();">
      <script>
         // Toggle function for panel help sections
         function togglePanelHelp(helpId) {
            var helpContent = document.getElementById(helpId);
            if (helpContent) {
               helpContent.classList.toggle('show');
            }
         }
         
         function toggleCollapsibleSection(sectionId) {
            var section = document.getElementById(sectionId);
            var icon = document.getElementById(sectionId + '-icon');
            if (section) {
               if (section.style.display === 'none') {
                  section.style.display = 'block';
                  if (icon) icon.className = 'fa fa-chevron-up';
               } else {
                  section.style.display = 'none';
                  if (icon) icon.className = 'fa fa-chevron-down';
               }
            }
         }
         
         $(document).ready(function() {  
         	// set up event handlers on input boxes
         	$('#latbox').change(function(){ latlongChanged(); });
         	$('#lngbox').change(function(){ latlongChanged(); });
         	$('#T').change(function(){ latlongChanged(); });
         	$('#disknew1').change(function(){ latlongChanged(); });
         	$('#disknew2').change(function(){ latlongChanged(); });
         	$('#disknew3').change(function(){ latlongChanged(); });
         	$('#age').change(function(){ latlongChanged(); });
         	$('#dist').change(function(){ latlongChanged(); });
         });
      </script>
      <!-- MODAL OVERLAY & POPUPS for Drawing Tools -->
      <div id="modal-overlay"></div>
      
      <!-- Intervisibility Field Selection Modal -->
      <div id="intervisibility-field-modal" class="custom-modal" style="width: 500px; max-width: 90vw; top: 10%; max-height: 85vh; overflow-y: auto;">
         <div class="custom-modal-header" style="background-color: var(--ai-green) !important; color: #ffffff !important; cursor: move;">
            <h3 style="color: #ffffff !important; margin: 0;"><i class="fa fa-table" style="color: #ffffff !important;"></i> Select GeoJSON Fields</h3>
         </div>
         <div class="custom-modal-body">
            <p class="text-muted small">Select which fields from your GeoJSON properties to use for unique identification and display names.</p>
            <div class="form-group">
               <label for="select-unique-id"><strong>Unique Identifier Field:</strong></label>
               <select id="select-unique-id" class="form-control">
                  <option value="">-- Select Field --</option>
               </select>
               <small class="text-muted">This field must contain unique values for each site. Used for statistics and matrix indexing.</small>
            </div>
            <div class="form-group">
               <label for="select-display-name"><strong>Display Name Field:</strong></label>
               <select id="select-display-name" class="form-control">
                  <option value="">-- Select Field (optional) --</option>
               </select>
               <small class="text-muted">This field will be used for marker labels and display in statistics. If not selected, the unique identifier will be used.</small>
            </div>
         </div>
         <div class="custom-modal-footer">
            <button class="btn btn-default" onclick="closeIntervisibilityFieldModal()">Cancel</button>
            <button class="btn btn-primary" id="confirm-field-selection-btn" onclick="confirmIntervisibilityFieldSelection()">Load Markers</button>
         </div>
      </div>

      <!-- Text Input Modal -->
      <div id="text-modal" class="custom-modal">
         <div class="custom-modal-header">
            <h3>Enter Label Text</h3>
         </div>
         <div class="custom-modal-body">
            <p class="text-muted small">Leave blank to create without a visible label.</p>
            <div class="form-group">
               <input type="text" id="text-input" class="form-control" placeholder="Type text here..." autocomplete="off">
            </div>
         </div>
         <div class="custom-modal-footer">
            <button class="btn btn-default" onclick="if(typeof window.drawingUI !== 'undefined') window.drawingUI.cancelTextModal()">Cancel</button>
            <button class="btn btn-primary" onclick="if(typeof window.drawingUI !== 'undefined') window.drawingUI.confirmTextModal()">Add Item</button>
         </div>
      </div>

      <!-- Confirmation Modal -->
      <div id="confirm-modal" class="custom-modal">
         <div class="custom-modal-header">
            <h3 class="text-danger"><i class="fa fa-exclamation-triangle"></i> Delete All?</h3>
         </div>
         <div class="custom-modal-body">
            <p>Are you sure you want to remove all drawings from the map? This action cannot be undone.</p>
         </div>
         <div class="custom-modal-footer">
            <button class="btn btn-default" onclick="if(typeof window.drawingUI !== 'undefined') window.drawingUI.closeConfirmModal()">Cancel</button>
            <button class="btn btn-danger" onclick="if(typeof window.DrawingToolsApp !== 'undefined' && window.DrawingToolsApp.drawingManager) window.DrawingToolsApp.drawingManager.clearAll()">Delete All</button>
         </div>
      </div>
      
      <!-- Intervisibility Field Selection Modal -->
      <div id="intervisibility-field-modal" class="custom-modal" style="width: 500px; max-width: 90vw;">
         <div class="custom-modal-header">
            <h3><i class="fa fa-table"></i> Select GeoJSON Fields</h3>
         </div>
         <div class="custom-modal-body">
            <p class="text-muted small">Select which fields from your GeoJSON properties to use for unique identification and display names.</p>
            <div class="form-group">
               <label for="select-unique-id"><strong>Unique Identifier Field:</strong></label>
               <select id="select-unique-id" class="form-control">
                  <option value="">-- Select Field --</option>
               </select>
               <small class="text-muted">This field must contain unique values for each site. Used for statistics and matrix indexing.</small>
            </div>
            <div class="form-group">
               <label for="select-display-name"><strong>Display Name Field:</strong></label>
               <select id="select-display-name" class="form-control">
                  <option value="">-- Select Field --</option>
               </select>
               <small class="text-muted">This field will be used for marker labels and display in statistics. If not selected, the unique identifier will be used.</small>
            </div>
            <div id="field-preview" style="margin-top: 15px; max-height: 200px; overflow-y: auto; border: 1px solid #ddd; padding: 10px; background-color: #f9f9f9; border-radius: 4px; display: none;">
               <strong>Available Fields (sample values):</strong>
               <table class="table table-condensed" style="margin-top: 10px; font-size: 11px;">
                  <thead>
                     <tr>
                        <th>Field Name</th>
                        <th>Sample Values</th>
                     </tr>
                  </thead>
                  <tbody id="field-preview-body">
                  </tbody>
               </table>
            </div>
         </div>
         <div class="custom-modal-footer">
            <button class="btn btn-default" onclick="closeIntervisibilityFieldModal()">Cancel</button>
            <button class="btn btn-primary" id="confirm-field-selection-btn" onclick="confirmIntervisibilityFieldSelection()">Load Markers</button>
         </div>
      </div>

      <div id="map"></div>
      <div id="sidebar" class="leaflet-sidebar collapsed">
         <!-- Nav tabs -->
         <div class="leaflet-sidebar-tabs">
            <ul role="tablist">
               <li><a href="#home" role="tab" data-toggle="tooltip" data-placement="right" data-container="body" title="Input Parameters"><i class="fa fa-edit"></i></a></li>
               <li><a href="#context" role="tab" data-toggle="tooltip" data-placement="right" data-container="body" title="View Azimuths"><i class="fa fa-list"></i></a></li>
               <li><a href="#methodology" role="tab" data-toggle="tooltip" data-placement="right" data-container="body" title="Horizon Probe"><i class="fa fa-area-chart"></i></a></li>
               <li><a href="#landscape" role="tab" data-toggle="tooltip" data-placement="right" data-container="body" title="Landscape Analysis"><i class="fa fa-sitemap"></i></a></li>
               <li><a href="#analysis" role="tab" data-toggle="tooltip" data-placement="right" data-container="body" title="Mapping Services"><i class="fa fa-map-marker"></i></a></li>
               <li><a href="#image" role="tab" data-toggle="tooltip" data-placement="right" data-container="body" title="Image Overlay"><i class="fa fa-image"></i></a></li>
               <li><a href="#hwt" role="tab" data-toggle="tooltip" data-placement="right" data-container="body" title="Markup"><i class="fa fa-pencil"></i></a></li>
               <li><a href="#quickview" role="tab" data-toggle="tooltip" data-placement="right" data-container="body" title="Quick View" style="opacity: 0.3; pointer-events: none;" id="quickview-tab"><i class="fa fa-eye"></i></a></li>
            </ul>
            <ul role="tablist">
               <li id="sidebar-file-icon-li"><a href="#file-upload" role="tab" data-toggle="tooltip" data-placement="right" data-container="body" title="Open Files (.geojson, .kml, .gpx)" id="sidebar-file-icon"><i class="fa fa-folder-open"></i></a></li>
               <li><a href="#settings" role="tab" data-toggle="tooltip" data-placement="right" data-container="body" title="About MACE"><i class="fa fa-info"></i></a></li>
            </ul>
         </div>
         <!-- Tab panes - Section 1 -->
         <div class="leaflet-sidebar-content">
            <div class="leaflet-sidebar-pane" id="home">
               <h1 class="leaflet-sidebar-header"> Input Parameters <span class="leaflet-sidebar-close"><i class="fa fa-chevron-left"></i></span> </h1>
               <div>
                  <div class="poibar-table">
                     <div class="rightpadding">
                        <!-- Tab panes - Section Content -->
                        <div id="lobipanel-multiple19">
                           <div class="panel panel-default">
                              <div class="panel-heading">
                                 <div class="panel-title">
                                    <h1 class="panel-title"><span class="fa fa-edit text-primary"></span>&nbsp;General Parameters
                                    </h1>
                                 </div>
                              </div>
                              <div class="panel-body">
                                 <div class="panel-help-link" onclick="togglePanelHelp('help-19')" title="Info/Help">
                                    <span>Info/Help</span>
                                    <i class="fa fa-info-circle"></i>
                                 </div>
                                 <div class="panel-help-content" id="help-19">
                                    <h5><i class="fa fa-info-circle"></i> General Parameters</h5>
                                    <p><strong>Selecting a Location:</strong> A location can be selected by dragging the center marker on the map combined with zooming to a specific area, or latitude and longitude may be input directly via the form fields below.</p>
                                    <p>Configure the fundamental astronomical and geographic parameters for your calculations:</p>
                                    <ul>
                                       <li><strong>Latitude:</strong> Enter the observer's latitude in decimal degrees (e.g., 53.4903). Positive values for Northern Hemisphere, negative for Southern.</li>
                                       <li><strong>Longitude:</strong> Enter the observer's longitude in decimal degrees (e.g., -7.5626). Positive values for Eastern Hemisphere, negative for Western.</li>
                                       <li><strong>Astronomical Date:</strong> Enter the date in astronomical format (negative values for BCE dates, e.g., -3400 for 3400 BCE). This accounts for precession and changes in Earth's axial tilt over time.</li>
                                       <li><strong>Position at Horizon:</strong> Select how the celestial body should be positioned relative to the horizon:
                                          <ul>
                                             <li><strong>Just fully above:</strong> When the entire disk is visible above the horizon</li>
                                             <li><strong>Centered at horizon:</strong> When the center of the disk is at the horizon line</li>
                                             <li><strong>Just fully below:</strong> When the disk is completely below the horizon (default)</li>
                                          </ul>
                                       </li>
                                    </ul>
                                    <p><strong>Important:</strong> If "Calculate Rise/Set Locations" is selected in Horizon Probe Options, the position at horizon must be set to the default "Just fully below horizon".</p>
                                    <p><strong>Note:</strong> These parameters form the foundation for all astronomical calculations, including solar and lunar rise/set positions. The azimuths displayed on the map are calculated for a zero (0) horizon and projected over the surface of a sphere as orthodromes (great circle paths).</p>
                                    <p><strong>Color Coding:</strong> The azimuths are displayed with color-coded dashed lines on the map to distinguish different celestial events:</p>
                                    <ul>
                                       <li style="border-left: 4px dashed #ffb74d; padding-left: 8px; margin: 4px 0;"><strong style="color: #ffb74d;">Solstices</strong> - Orange/amber shades: Summer and winter solstice sunrise/sunset positions</li>
                                       <li style="border-left: 4px dashed #fff176; padding-left: 8px; margin: 4px 0;"><strong style="color: #fff176;">Equinoxes</strong> - Yellow shades: Spring and autumn equinox sunrise/sunset positions</li>
                                       <li style="border-left: 4px dashed #aed581; padding-left: 8px; margin: 4px 0;"><strong style="color: #aed581;">Cross-Quarters</strong> - Green shades: Midpoints between solstices and equinoxes (Imbolc, Beltane, Lughnasadh, Samhain)</li>
                                       <li style="border-left: 4px dashed #7283a7; padding-left: 8px; margin: 4px 0;"><strong style="color: #7283a7;">Major Lunar Standstills</strong> - Blue/grey shades: Extreme lunar positions (every ~18.6 years)</li>
                                       <li style="border-left: 4px dashed #ff8a65; padding-left: 8px; margin: 4px 0;"><strong style="color: #ff8a65;">Minor Lunar Standstills</strong> - Red/orange shades: Minimum lunar declination range</li>
                                    </ul>
                                 </div>
                                 <!-- Panel Content -->
                                 <div class="col-xs-12">
                                    <label for="lat">Latitude</label>
                                    <input id="latbox" name="latbox" class="form-control col-xs-2" size="4" value="53.4902668" type="text">
                                    <span class="help-block">Enter latitude </span>
                                 </div>
                                 <div class="col-xs-12">
                                    <label for="lon">Longitude</label>
                                    <input id="lngbox" name="lon" class="form-control col-xs-2" size="4" value="-7.56256669" type="text">
                                    <span class="help-block">Enter longitude </span>
                                 </div>
                                 <div class="col-xs-12">
                                    <label for="age">Astronomical Date</label>
                                    <input id="age" name="age" class="form-control col-xs-2" size="5" value="-3400" type="text">
                                    <span class="help-block">Enter Date</span>
                                 </div>
                                 <div class="col-sm-12 ">
                                    <div class="form-group">
                                       <label  for="radios">Position at horizon</label>
                                       <div class="radio">
                                          <label for="radios-0">
                                          <input id="disknew1" name="disknew" value="1" type="radio">
                                          Just fully above horizon </label>
                                       </div>
                                       <div class="radio">
                                          <label for="radios-1">
                                          <input id="disknew2" name="disknew" value="2" type="radio">
                                          Centered at horizon</label>
                                       </div>
                                       <div class="radio">
                                          <label for="radios-1">
                                          <input id="disknew3" name="disknew" value="3" checked="checked" type="radio">
                                          Just fully below horizon</label>
                                       </div>
                                    </div>
                                 </div>
                              </div>
                           </div>
                        </div>
                        <div id="lobipanel-multiple14">
                           <div class="panel panel-default">
                              <div class="panel-heading">
                                 <div class="panel-title">
                                    <h1 class="panel-title"><span class="fa fa-edit text-primary"></span>&nbsp;Additional Parameters
                                    </h1>
                                 </div>
                              </div>
                              <div class="panel-body">
                                 <div class="panel-help-link" onclick="togglePanelHelp('help-14')" title="Info/Help">
                                    <span>Info/Help</span>
                                    <i class="fa fa-info-circle"></i>
                                 </div>
                                 <div class="panel-help-content" id="help-14">
                                    <h5><i class="fa fa-info-circle"></i> Additional Parameters</h5>
                                    <p>Configure atmospheric and measurement parameters that affect astronomical calculations:</p>
                                    <ul>
                                       <li><strong>Distance:</strong> Maximum projection distance in kilometers for calculations (default: 999 km). This determines how far the system will search for horizon intersections.</li>
                                       <li><strong>Temperature:</strong> Air temperature in Celsius (default: 15C). Used for atmospheric refraction calculations. Use the same height reference as air pressure.</li>
                                       <li><strong>Air Pressure:</strong> Atmospheric pressure in millibars (default: 1013.25 mb, standard sea level). Affects atmospheric refraction and light bending.</li>
                                       <li><strong>Latitude +/-:</strong> Latitude error tolerance in degrees (default: 0.01). Used for uncertainty calculations in azimuth determinations.</li>
                                       <li><strong>Air Pressure @:</strong> Select the reference height for air pressure:
                                          <ul>
                                             <li><strong>Eye height level:</strong> Pressure measured at observer's eye height (default)</li>
                                             <li><strong>Sea height level:</strong> Pressure measured at sea level (requires altitude correction)</li>
                                          </ul>
                                       </li>
                                    </ul>
                                    <p><strong>Tip:</strong> For accurate calculations, use local weather station data for temperature and pressure when available. Standard atmospheric conditions (15C, 1013.25 mb) work well for most applications.</p>
                                 </div>
                                 <!-- Panel Content -->
                                 <div class="col-xs-12">
                                    <label for="distance">Distance</label>
                                    <input id="dist" name="dist" class="dist form-control col-xs-2" size="4" value="999" type="text">
                                    <span class="help-block">Enter desired projections distance in km</span>
                                 </div>
                                 <div class="col-xs-12">
                                    <label for="Temperature">Temperature</label>
                                    <input id="T" name="T" class="form-control col-xs-2" size="2" value="15">
                                    <span class="help-block">Enter temperature in  celsius using same height reference as Air pressure</span>
                                 </div>
                                 <div class="col-xs-12">
                                    <label for="Air pressure">Air pressure</label>
                                    <input id="P" name="P" type="text" class="form-control col-xs-2" size="5" value="1013.25">
                                    <span class="help-block">Enter air pressure in millibars</span>
                                 </div>
                                 <div class="col-xs-12">
                                    <label for="Latitude +/-">Latitude +/</label>
                                    <input id="errorlat" name="errorlat" class="form-control col-xs-2" size="4" value="0.01">
                                    <span class="help-block">Latitude error</span>
                                 </div>
                                 <div class="col-sm-12 ">
                                    <div class="form-group">
                                       <label  for="radios">Air Pressure @</label>
                                       <div class="radio">
                                          <label for="radios-0">
                                          <input id="height1" name="height" value = '1'" checked="checked" type="radio">
                                          Eye height level </label>
                                       </div>
                                       <div class="radio">
                                          <label for="radios-1">
                                          <input id="height2" name="height" value = '2'" type="radio">
                                          Sea height level</label>
                                       </div>
                                    </div>
                                 </div>
                              </div>
                           </div>
                        </div>
                        <!-- Tab panes - End Section Content -->  
                     </div>
                  </div>
               </div>
            </div>
            <div class="leaflet-sidebar-pane" id="analysis">
               <h1 class="leaflet-sidebar-header"> Mapping Services <span class="leaflet-sidebar-close"><i class="fa fa-chevron-left"></i></span> </h1>
               <div>
                  <div class="poibar-table">
                     <div class="rightpadding">
                        <div id="lobipanel-multiple20">
                           <div class="panel panel-default">
                              <div class="panel-heading">
                                 <div class="panel-title">
                                    <h1 class="panel-title"><span class="fa fa-map-marker text-primary"></span>&nbsp;Mapping Services Ireland </h1>
                                 </div>
                              </div>
                              <div class="panel-body">
                                 <div class="panel-help-link" onclick="togglePanelHelp('help-20')" title="Info/Help">
                                    <span>Info/Help</span>
                                    <i class="fa fa-info-circle"></i>
                                 </div>
                                 <div class="panel-help-content" id="help-20">
                                    <h5><i class="fa fa-info-circle"></i> Mapping Services Ireland</h5>
                                    <p>Access and display archaeological and historical site data from Irish mapping services:</p>
                                    <ul>
                                       <li><strong>Search Location:</strong> Enter a city name, address, or coordinates (lat,lon) to quickly navigate to a location on the map.</li>
                                       <li><strong>Quick Select:</strong> Choose from preset services:
                                          <ul>
                                             <li><strong>Irish SMR (Republic):</strong> Sites and Monuments Record for the Republic of Ireland</li>
                                             <li><strong>Northern Irish SMR:</strong> Historic Environment Division GIS Data for Northern Ireland</li>
                                          </ul>
                                       </li>
                                       <li><strong>Service URL:</strong> Enter or paste an ArcGIS Feature Server URL to access custom mapping services. The system will detect the service type automatically.</li>
                                       <li><strong>Fetch Layer Info:</strong> Click to retrieve available layers from the selected service. Once loaded, select a layer to display on the map.</li>
                                    </ul>
                                    <p><strong>Usage:</strong> 1) Select or enter a service URL, 2) Click "Fetch Layer Info", 3) Choose a layer from the dropdown, 4) Enable "Show on Map" to display features. Features will appear as markers or polygons on the map.</p>
                                 </div>
                                 <!-- Panel Content -->
                                 
                                             <div class="form-group mb-3" style="border-bottom: 1px solid #eee; padding-bottom: 15px;">
                <label class="text-muted small font-bold">Search Location</label>
                <div class="input-group input-group-sm">
                    <input type="text" id="MS_searchInput" class="form-control" placeholder="City, Address, or Lat,Lon...">
                    <span class="input-group-btn">
                        <button class="btn btn-default" type="button" id="MS_btnSearch">
                            <span class="fa fa-search"></span>
                        </button>
                    </span>
                </div>
            </div>

            <div class="form-group mb-3">
                <label class="text-muted small font-bold">Quick Select</label>
                <select id="MS_presetSelect" class="form-control input-sm mb-2">
                    <option value="https://services-eu1.arcgis.com/HyjXgkV6KGMSF3jt/arcgis/rest/services/SMROpenData/FeatureServer">Irish SMR (Republic)</option>
                    <option value="https://services2.arcgis.com/BdBkthNLO9mzGAMO/arcgis/rest/services/Historic_Environment_Division_GIS_Data/FeatureServer">Northern Irish SMR</option>
                </select>

                <label class="text-muted small font-bold mt-2">Service URL</label>
                <input type="text" id="MS_capUrl" 
                    class="form-control input-sm"
                    value="https://services-eu1.arcgis.com/HyjXgkV6KGMSF3jt/arcgis/rest/services/SMROpenData/FeatureServer"
                    placeholder="Paste URL here...">
                <div class="clearfix"><span id="MS_detectedType" class="ms-type-badge">Ready</span></div>
            </div>

            <button id="MS_btnLoad" class="btn btn-primary btn-block btn-sm font-bold mb-3">1. Fetch Layer Info</button>
            <div id="MS_status" class="alert alert-info py-2 px-3 small hidden" role="alert" style="padding: 8px; margin-bottom: 15px;"></div>

            <div id="MS_layerSection" style="opacity: 0.5; pointer-events: none; transition: opacity 0.3s;">
                <div class="mb-3">
                    <label class="text-muted small font-bold">Detected Layer</label>
                    <select id="MS_layerSelect" class="form-control input-sm"><option value="">(No layers loaded)</option></select>
                    <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-top: 5px;">
                        <p class="small text-muted mb-0" id="MS_layerNameDisplay">Name: <span class="text-dark font-bold">-</span></p>
                        <p class="small text-primary font-bold mb-0" id="MS_versionDisplay"></p>
                    </div>
                    <div class="checkbox mt-2" style="border-top: 1px solid #eee; padding-top: 10px;">
                        <label class="small font-bold text-dark">
                            <input type="checkbox" id="MS_toggleHeatmap"> View as Heatmap
                        </label>
                    </div>
                </div>

                <!-- QUERY CONTROLS -->
                <div id="MS_queryContainer" class="hidden mb-3 well well-sm">
                    <div class="checkbox mb-2" style="border-bottom: 1px solid #ccc; padding-bottom: 5px; margin-top: 0;">
                        <label class="small font-bold text-dark">
                            <input type="checkbox" id="MS_enableQuery"> Create Query (Filter)
                        </label>
                    </div>
                    
                    <div id="MS_queryControls" class="hidden">
                        <label class="small font-bold text-muted mt-1">1. Select Category Attribute</label>
                        <select id="MS_attributeSelect" class="form-control input-sm mb-2"><option value="">Loading attributes...</option></select>
                        <button id="MS_btnFetchValues" class="btn btn-default btn-sm btn-block font-bold mb-2">Load Unique Values</button>
                        <div id="MS_uniqueValuesContainer" class="hidden">
                            <label class="small font-bold text-muted mb-1">2. Select Values & Add Specific Text Filters</label>
                            <p class="small text-muted mb-1" style="font-size: 9px;">Check a box to reveal its specific text search options.</p>
                            <div id="MS_uniqueValuesList" class="ms-checkbox-list bg-white"></div>
                            <button id="MS_btnRunQuery" class="btn btn-primary btn-sm btn-block font-bold mt-2">Apply Filter to Map</button>
                        </div>
                    </div>
                </div>

                <!-- Manual Override Details -->
                <div class="mb-3">
                    <a href="#" id="MS_toggleAdvanced" class="small text-primary font-bold">Advanced / Manual Settings</a>
                    <div id="MS_advancedSettings" class="hidden mt-2 well well-sm">
                        <label class="small font-bold text-muted">Base Service URL</label>
                        <input type="text" id="MS_baseUrl" class="form-control input-sm mb-2" value="">
                        
                        <div id="MS_wmsOptions">
                            <label class="small font-bold text-muted">Format</label>
                            <select id="MS_format" class="form-control input-sm mb-2">
                                <option value="image/png">image/png</option>
                                <option value="image/jpeg">image/jpeg</option>
                            </select>
                        </div>
                        
                        <div id="MS_wfsTechnicalOptions" class="hidden">
                            <label class="small font-bold text-muted">WFS Strategy</label>
                            <p class="text-muted mb-2" style="font-size: 11px;">Strategy: <strong>Zoom Level > 10 + BBOX</strong>.</p>
                            <label class="small font-bold text-muted mt-2">Force Projection (SRS)</label>
                            <select id="MS_srsSelect" class="form-control input-sm mb-1">
                                <option value="EPSG:4326">EPSG:4326 (Lat/Lon)</option>
                                <option value="EPSG:3857">EPSG:3857 (Web Mercator)</option>
                            </select>
                        </div>
                    </div>
                </div>

                <button id="MS_btnAdd" class="btn btn-success btn-block font-bold mb-2">Add Layer to Map</button>
                <div id="MS_loadingIndicator" class="hidden mt-2 text-center small text-primary font-bold bg-info p-2 rounded" style="padding: 8px;">
                     Loading Data...
                </div>
                <button id="MS_btnClear" class="btn btn-default btn-block btn-sm font-bold">Clear Map</button>
                
                <button id="MS_btnExport" class="btn btn-info btn-block mt-3 font-bold btn-sm">
                    Export Markers (GeoJSON)
                </button>
            </div>











                              </div>
                           </div>
                        </div>
                     </div>
                  </div>
               </div>
            </div>
            <!-- Tab panes - Context -->	
            <div class="leaflet-sidebar-pane" id="context">
               <h1 class="leaflet-sidebar-header"> View Azimuths <span class="leaflet-sidebar-close"><i class="fa fa-chevron-left"></i></span> </h1>
               <div>
                  <div class="poibar-table">
                     <div class="rightpadding">
                        <div id="lobipanel-multiple1">
                           <div class="panel panel-default">
                              <div class="panel-heading">
                                 <div class="panel-title">
                                    <h1 class="panel-title"><span class="fa fa-list text-primary"></span>&nbsp;Solar - Lunar Azimuths</h1>
                                 </div>
                              </div>
                              <div class="panel-body">
                                 <div class="panel-help-link" onclick="togglePanelHelp('help-1')" title="Info/Help">
                                    <span>Info/Help</span>
                                    <i class="fa fa-info-circle"></i>
                                 </div>
                                 <div class="panel-help-content" id="help-1">
                                    <h5><i class="fa fa-info-circle"></i> Solar - Lunar Azimuths</h5>
                                    <p>View calculated azimuth angles for key solar and lunar events throughout the year:</p>
                                    <ul>
                                       <li><strong>Solstices:</strong> Extreme positions of the Sun:
                                          <ul>
                                             <li><strong>Summer Northern Sunrise/Sunset:</strong> Most northerly rising and setting points (around June 21)</li>
                                             <li><strong>Winter Southern Sunrise/Sunset:</strong> Most southerly rising and setting points (around December 21)</li>
                                          </ul>
                                       </li>
                                       <li><strong>Equinoxes:</strong> When day and night are equal length (around March 21 and September 23). The Sun rises due east and sets due west.</li>
                                       <li><strong>Cross-Quarters:</strong> Midpoints between solstices and equinoxes (Imbolc, Beltane, Lughnasadh, Samhain). Important in Celtic calendar systems.</li>
                                       <li><strong>Major Lunar Standstills:</strong> Extreme positions of the Moon (occurring every ~18.6 years). The Moon reaches its maximum declination range.</li>
                                       <li><strong>Minor Lunar Standstills:</strong> Minimum declination range of the Moon (opposite phase of the 18.6-year cycle).</li>
                                    </ul>
                                    <p><strong>Note:</strong> All azimuths are calculated based on your General Parameters (latitude, longitude, astronomical date). Values are displayed in degrees from true north (0 = North, 90 = East, 180 = South, 270 = West) and are projected as orthodromes (great circle paths) on the map using color-coded dashed lines.</p>
                                 </div>
                                 <legend>Solstices</legend>
                                 <div class='col-sm-12'>
                                    <div class="form-group">
                                       <label class="col-xs-12 control-label" for="solsticeazisumrise">Summer northern sunrise</label>
                                       <div class="col-xs-12">
                                          <div class="input-group">
                                             <span class="input-group-addon solstice-bg input-sm">Bearing </span>
                                             <input id="solsticeazisumrise" name="solsticeazisumrise" class="form-control" type="text" size="4" value="00.00">
                                          </div>
                                       </div>
                                    </div>
                                 </div>
                                 <div class='col-sm-12'>
                                    <div class="form-group">
                                       <label class="col-xs-12 control-label" for="solsticeazisumset">Summer northern sunset</label>
                                       <div class="col-xs-12">
                                          <div class="input-group">
                                             <span class="input-group-addon solsticefb-bg input-sm">Bearing </span>
                                             <input id="solsticeazisumset" name="solsticeazisumset" class="form-control" type="text" size="4" value="00.00">
                                          </div>
                                       </div>
                                    </div>
                                 </div>
                                 <div class='col-sm-12'>
                                    <div class="form-group">
                                       <label class="col-xs-12 control-label" for="solsticeaziwinrise">Winter southern sunrise</label>
                                       <div class="col-xs-12">
                                          <div class="input-group">
                                             <span class="input-group-addon solsticelat-bg input-sm">Bearing </span>
                                             <input id="solsticeaziwinrise" name="solsticeaziwinrise" class="form-control" type="text" size="4" value="00.00">
                                          </div>
                                       </div>
                                    </div>
                                 </div>
                                 <div class='col-sm-12'>
                                    <div class="form-group">
                                       <label class="col-xs-12 control-label" for="solsticeaziwinset">Winter southern sunset</label>
                                       <div class="col-xs-12">
                                          <div class="input-group">
                                             <span class="input-group-addon solsticelong-bg input-sm">Bearing </span>
                                             <input id="solsticeaziwinset" name="solsticeaziwinset" class="form-control" type="text" size="4" value="00.00">
                                          </div>
                                       </div>
                                    </div>
                                 </div>
                                 <div class="col-xs-12" style="height:20px;"></div>
                                 <legend>Cross Quarters</legend>
                                 <div class='col-sm-12'>
                                    <div class="form-group">
                                       <label class="col-xs-12 control-label" for="crossquarterazisumrise">Northern sunrise</label>
                                       <div class="col-xs-12">
                                          <div class="input-group">
                                             <span class="input-group-addon crossquarter-bg input-sm">Bearing </span>
                                             <input id="crossquarterazisumrise" name="crossquarterazisumrise" class="form-control" type="text" size="4" value="00.00">
                                          </div>
                                       </div>
                                    </div>
                                 </div>
                                 <div class='col-sm-12'>
                                    <div class="form-group">
                                       <label class="col-xs-12 control-label" for="crossquarterazisumrise">Northern sunset</label>
                                       <div class="col-xs-12">
                                          <div class="input-group">
                                             <span class="input-group-addon crossquarterfb-bg input-sm">Bearing </span>
                                             <input id="crossquarterazisumset" name="crossquarterazisumset" class="form-control" type="text" size="4" value="00.00">
                                          </div>
                                       </div>
                                    </div>
                                 </div>
                                 <div class='col-sm-12'>
                                    <div class="form-group">
                                       <label class="col-xs-12 control-label" for="crossquarteraziwinrise">Southern sunrise</label>
                                       <div class="col-xs-12">
                                          <div class="input-group">
                                             <span class="input-group-addon crossquarterlat-bg input-sm">Bearing </span>
                                             <input id="crossquarteraziwinrise" name="crossquarteraziwinrise" class="form-control" type="text" size="4" value="00.00">
                                          </div>
                                       </div>
                                    </div>
                                 </div>
                                 <div class='col-sm-12'>
                                    <div class="form-group">
                                       <label class="col-xs-12 control-label" for="crossquarteraziwinrise">Southern sunset</label>
                                       <div class="col-xs-12">
                                          <div class="input-group">
                                             <span class="input-group-addon crossquarterlat-bg input-sm">Bearing </span>
                                             <input id="crossquarteraziwinset" name="crossquarteraziwinset" class="form-control" type="text" size="4" value="00.00">
                                          </div>
                                       </div>
                                    </div>
                                 </div>
                                 <div class="col-xs-12" style="height:20px;"></div>
                                 <legend>Equinoxs</legend>
                                 <div class='col-sm-12'>
                                    <div class="form-group">
                                       <label class="col-xs-12 control-label" for="equinoxazisumrise">Eastern sunrise</label>
                                       <div class="col-xs-12">
                                          <div class="input-group">
                                             <span class="input-group-addon equinox-bg input-sm">Bearing </span>
                                             <input id="equinoxazisumrise" name="equinoxazisumrise" class="form-control" type="text" size="4" value="00.00">
                                          </div>
                                       </div>
                                    </div>
                                 </div>
                                 <div class='col-sm-12'>
                                    <div class="form-group">
                                       <label class="col-xs-12 control-label" for="equinoxazisumset">Western sunset</label>
                                       <div class="col-xs-12">
                                          <div class="input-group">
                                             <span class="input-group-addon equinoxfb-bg input-sm">Bearing </span>
                                             <input id="equinoxazisumset" name="equinoxazisumset" class="form-control" type="text" size="4" value="00.00">
                                          </div>
                                       </div>
                                    </div>
                                 </div>
                                 <div class="col-xs-12" style="height:20px;"></div>
                                 <legend>Major Standstills</legend>
                                 <div class='col-sm-12'>
                                    <div class="form-group">
                                       <label class="col-xs-12 control-label" for="majorazisumrise">Northern moonrise</label>
                                       <div class="col-xs-12">
                                          <div class="input-group">
                                             <span class="input-group-addon major-bg input-sm">Bearing </span>
                                             <input id="majorazisumrise" name="majorazisumrise" class="form-control" type="text" size="4" value="00.00">
                                          </div>
                                       </div>
                                    </div>
                                 </div>
                                 <div class='col-sm-12'>
                                    <div class="form-group">
                                       <label class="col-xs-12 control-label" for="majorazisumset">Northern moonset</label>
                                       <div class="col-xs-12">
                                          <div class="input-group">
                                             <span class="input-group-addon majorfb-bg input-sm">Bearing </span>
                                             <input id="majorazisumset" name="majorazisumset" class="form-control" type="text" size="4" value="00.00">
                                          </div>
                                       </div>
                                    </div>
                                 </div>
                                 <div class='col-sm-12'>
                                    <div class="form-group">
                                       <label class="col-xs-12 control-label" for="majoraziwinrise">Southern moonrise</label>
                                       <div class="col-xs-12">
                                          <div class="input-group">
                                             <span class="input-group-addon majorlat-bg input-sm">Bearing </span>
                                             <input id="majoraziwinrise" name="majoraziwinrise" class="form-control" type="text" size="4" value="00.00">
                                          </div>
                                       </div>
                                    </div>
                                 </div>
                                 <div class='col-sm-12'>
                                    <div class="form-group">
                                       <label class="col-xs-12 control-label" for="majoraziwinset">Southern moonset</label>
                                       <div class="col-xs-12">
                                          <div class="input-group">
                                             <span class="input-group-addon majorlong-bg input-sm">Bearing </span>
                                             <input id="majoraziwinset" name="majoraziwinset" class="form-control" type="text" size="4" value="00.00">
                                          </div>
                                       </div>
                                    </div>
                                 </div>
                                 <div class="col-xs-12" style="height:20px;"></div>
                                 <legend>Minor Standstills</legend>
                                 <div class='col-sm-12'>
                                    <div class="form-group">
                                       <label class="col-xs-12 control-label" for="minorazisumrise">Northern moonrise</label>
                                       <div class="col-xs-12">
                                          <div class="input-group">
                                             <span class="input-group-addon minor-bg input-sm">Bearing </span>
                                             <input id="minorazisumrise" name="minorazisumrise" class="form-control" type="text" size="4" value="00.00">
                                          </div>
                                       </div>
                                    </div>
                                 </div>
                                 <div class='col-sm-12'>
                                    <div class="form-group">
                                       <label class="col-xs-12 control-label" for="minorazisumset">Northern moonset</label>
                                       <div class="col-xs-12">
                                          <div class="input-group">
                                             <span class="input-group-addon minorfb-bg input-sm">Bearing </span>
                                             <input id="minorazisumset" name="minorazisumset" class="form-control" type="text" size="4" value="00.00">
                                          </div>
                                       </div>
                                    </div>
                                 </div>
                                 <div class='col-sm-12'>
                                    <div class="form-group">
                                       <label class="col-xs-12 control-label" for="minoraziwinrise">Southern moonrise</label>
                                       <div class="col-xs-12">
                                          <div class="input-group">
                                             <span class="input-group-addon minorlat-bg input-sm">Bearing </span>
                                             <input id="minoraziwinrise" name="minoraziwinrise" class="form-control" type="text" size="4" value="00.00">
                                          </div>
                                       </div>
                                    </div>
                                 </div>
                                 <div class='col-sm-12'>
                                    <div class="form-group">
                                       <label class="col-xs-12 control-label" for="minoraziwinset">Southern moonset</label>
                                       <div class="col-xs-12">
                                          <div class="input-group">
                                             <span class="input-group-addon minorlong-bg input-sm">Bearing </span>
                                             <input id="minoraziwinset" name="minoraziwinset" class="form-control" type="text" size="4" value="00.00">
                                          </div>
                                       </div>
                                    </div>
                                 </div>
                                 <div class="col-xs-12" style="height:20px;"></div>
                                 <legend>North - South</legend>
                                 <div class='col-sm-12'>
                                    <div class="form-group">
                                       <label class="col-xs-12 control-label" for="crossquarterazisumrise">North</label>
                                       <div class="col-xs-12">
                                          <div class="input-group">
                                             <span class="input-group-addon north-bg input-sm">Bearing </span>
                                             <input id="north" name="north" class="form-control" type="text" size="4" value="00.00">
                                          </div>
                                       </div>
                                    </div>
                                 </div>
                                 <div class='col-sm-12'>
                                    <div class="form-group">
                                       <label class="col-xs-12 control-label" for="crossquarterazisumrise">South</label>
                                       <div class="col-xs-12">
                                          <div class="input-group">
                                             <span class="input-group-addon south-bg input-sm">Bearing </span>
                                             <input id="south" name="south" class="form-control" type="text" size="4" value="180.00">
                                          </div>
                                       </div>
                                    </div>
                                 </div>
                              </div>
                           </div>
                        </div>
                     </div>
                  </div>
               </div>
            </div>
            <!-- Tab panes - Methodology / Horizon Profiler -->
            <div class="leaflet-sidebar-pane" id="methodology">
               <h1 class="leaflet-sidebar-header"> Horizon Probe <span class="leaflet-sidebar-close"><i class="fa fa-chevron-left"></i></span> </h1>
               <div>
                  <div class="poibar-table">
                     <div class="rightpadding">
                        <div id="lobipanel-multiple8">
                           <div class="panel panel-default">
                              <div class="panel-heading">
                                 <div class="panel-title">
                                    <h1 class="panel-title"><span class="fa fa-area-chart text-primary"></span>&nbsp;Horizon Probe Options
                                    </h1>
                                 </div>
                              </div>
                              <div class="panel-body">
                                 <div class="panel-help-link" onclick="togglePanelHelp('help-8')" title="Info/Help">
                                    <span>Info/Help</span>
                                    <i class="fa fa-info-circle"></i>
                                 </div>
                                 <div class="panel-help-content" id="help-8">
                                    <h5><i class="fa fa-info-circle"></i> Horizon Probe Options</h5>
                                    <p>Calculate horizon profiles and rise/set locations using digital elevation data:</p>
                                    <ul>
                                       <li><strong>Location Input:</strong> Enter latitude and longitude, or use "Calculate Current Location" to use the map center, or "Place Marker" to click on the map.</li>
                                       <li><strong>Calculate Rise/Set Locations:</strong> Find where celestial bodies rise and set on the actual terrain horizon. Results are displayed on the map as color-coded markers and viewshed horizon polylines. The "Save Rise/Set Locations" button appears after calculations complete and exports all markers, polylines, the full viewshed horizon, and the calculation point to a GeoJSON file. The "Open Saved Rise/Set Locations" button allows you to import previously saved data, restoring all markers, polylines, viewshed horizon, and calculation point.</li>
                                       <li><strong>Create Horizon Probe:</strong> Generate a 360 horizon profile showing elevation angles in all directions. Displays as a chart and panoramic view. Export to Stellarium is optional.</li>
                                       <li><strong>Resolution Options:</strong>
                                          <ul>
                                             <li><strong>Quick:</strong> Fast calculation with 360 radial samples at zoom level 11 (~2.4 km per pixel). Best for quick testing of locations and initial exploration. Uses lower sample count for faster results.</li>
                                             <li><strong>Hi-Res:</strong> Higher detail with 3600 radial samples at zoom level 11 (~2.4 km per pixel). Better accuracy than Quick while maintaining reasonable speed. Recommended for most analyses. Same terrain resolution as Quick but with 10x more samples for smoother profile.</li>
                                             <li><strong>Super:</strong> High detail with 3600 radial samples at zoom level 12 (~1.2 km per pixel). Significantly more accurate terrain representation with moderate increase in calculation time. Uses higher resolution terrain data for better accuracy.</li>
                                             <li><strong>Max:</strong> Maximum detail with 3600 radial samples using a hybrid approach. Calculates initial horizon profile with zoom level 12 terrain (~1.2 km per pixel), then downloads zoom level 14 tiles (~300 m per pixel) only for actual horizon points with a 500-meter buffer zone. Highest possible accuracy at the horizon while minimizing data download. Requires more time but downloads only necessary high-resolution tiles.</li>
                                          </ul>
                                       </li>
                                       <li><strong>Steps:</strong> Number of radial directions to sample. Quick uses 360 steps, all other resolutions use 3600 steps for a full 360 profile. More steps = smoother profile but slower calculation.</li>
                                    </ul>
                                    <p><strong>Tip:</strong> Start with Quick resolution to test locations, then use higher resolutions for final analysis. Hi-Res provides a good balance of speed and accuracy. Super offers better terrain detail. Max provides the highest accuracy at the horizon using an efficient hybrid approach. The horizon profile accounts for terrain blocking and atmospheric refraction.</p>
                                 </div>
                                 <!-- Location Input Form -->
                                 <div style="margin-top: 15px; padding: 10px; background-color: #f9f9f9; border-radius: 4px; border-top: 1px solid #ddd;">
                                    <div class="form-group" style="margin-bottom:15px; padding-bottom:15px; border-bottom:1px solid #ddd;">
                                       <div class="row">
                                          <div class="col-xs-6">
                                             <label class="small">Latitude</label>
                                             <input type="number" class="form-control input-sm" id="hc-test-lat" step="0.000001" value="53.490266" placeholder="Latitude">
                                          </div>
                                          <div class="col-xs-6">
                                             <label class="small">Longitude</label>
                                             <input type="number" class="form-control input-sm" id="hc-test-lng" step="0.000001" value="-7.5625666" placeholder="Longitude">
                                          </div>
                                       </div>
                                       <button id="btn-go-to-location" class="btn btn-xs btn-block" style="margin-top:8px; height: 28px; background-color: #9b59b6; border-color: #8e44ad; color: white;" onmouseover="this.style.backgroundColor='#8e44ad'" onmouseout="this.style.backgroundColor='#9b59b6'">
                                          <i class="fa fa-play"></i> Calculate Current Location
                                       </button>
                                       <div style="text-align:center; margin:8px 0; color:#666; font-size:12px;">or</div>
                                       <button id="btn-start" class="btn btn-success btn-xs btn-block" style="height: 28px;">
                                          <i class="fa fa-map-marker"></i> Place Marker
                                       </button>
                                    </div>
                                    <div class="form-group">
                                       <div class="checkbox">
                                          <label>
                                             <input type="checkbox" id="chk-rise-set"> Calculate Rise/Set Locations
                                          </label>
                                       </div>
                                       <div class="checkbox">
                                          <label>
                                             <input type="checkbox" id="chk-profile" checked> Create Horizon Probe
                                          </label>
                                       </div>
                                    </div>

                                    <div class="form-group checkbox-group">
                                       <label style="display:block; font-weight:bold;">Horizon Probe Resolution:</label>
                                       <div class="checkbox">
                                          <label>
                                             <input type="checkbox" name="res-probe" class="res-chk-probe" id="res-probe-quick" checked> Quick
                                          </label>
                                       </div>
                                       <div class="checkbox">
                                          <label>
                                             <input type="checkbox" name="res-probe" class="res-chk-probe" id="res-probe-hires"> Hi-Res
                                          </label>
                                       </div>
                                       <div class="checkbox">
                                          <label>
                                             <input type="checkbox" name="res-probe" class="res-chk-probe" id="res-probe-super"> Super
                                          </label>
                                       </div>
                                       <div class="checkbox">
                                          <label>
                                             <input type="checkbox" name="res-probe" class="res-chk-probe" id="res-probe-max"> Max
                                             <i class="fa fa-exclamation-triangle text-danger" style="margin-left: 5px;" title="High memory usage - uses Z14 only at horizon"></i>
                                          </label>
                                       </div>
                                    </div>
                                    
                                    <div class="form-group checkbox-group">
                                       <label style="display:block; font-weight:bold;">Rise/Set Resolution:</label>
                                       <div class="checkbox">
                                          <label>
                                             <input type="checkbox" name="res-riseset" class="res-chk-riseset" id="res-riseset-quick" checked> Quick
                                          </label>
                                       </div>
                                       <div class="checkbox">
                                          <label>
                                             <input type="checkbox" name="res-riseset" class="res-chk-riseset" id="res-riseset-hires"> Hi-Res
                                          </label>
                                       </div>
                                       <div class="checkbox">
                                          <label>
                                             <input type="checkbox" name="res-riseset" class="res-chk-riseset" id="res-riseset-super"> Super
                                          </label>
                                       </div>
                                       <div class="checkbox">
                                          <label>
                                             <input type="checkbox" name="res-riseset" class="res-chk-riseset" id="res-riseset-max"> Max
                                             <i class="fa fa-exclamation-triangle text-danger" style="margin-left: 5px;" title="High memory usage - uses Z14 only at horizon"></i>
                                          </label>
                                       </div>
                                       <div id="res-riseset-warning" class="text-warning" style="margin-top:5px; font-size:11px; display:none;">
                                          <i class="fa fa-info-circle"></i> High resolution rise/set requires high resolution horizon probe to be run first.
                                       </div>
                                    </div>
                                    <div id="status-msg" class="text-info" style="margin-top:10px; display:none; font-size:12px;">
                                       <i class="fa fa-info-circle"></i> <span id="status-text">Ready</span>
                                    </div>
                                 </div>
                                 <div style="margin-top: 15px; padding: 10px; background-color: #f9f9f9; border-radius: 4px; border-top: 1px solid #ddd;">
                                    <div style="margin-bottom: 8px;">
                                       <button id="btn-view-horizon-results" class="btn btn-xs" onclick="if($('#hc-results-panel').is(':hidden') || $('#hc-results-panel').hasClass('minimized')) { $('#hc-results-panel').css('display', 'flex').removeClass('minimized').addClass('expanded'); $('#icon-toggle').attr('class', 'fa fa-window-minimize'); } else { $('#hc-results-panel').css('display', 'flex').removeClass('minimized').addClass('expanded'); }" style="display: none; width: 100%; margin-bottom: 5px; height: 28px; background-color: #9b59b6; border-color: #8e44ad; color: white;" onmouseover="this.style.backgroundColor='#8e44ad'" onmouseout="this.style.backgroundColor='#9b59b6'">
                                          <i class="fa fa-area-chart"></i> View Horizon Results
                                       </button>
                                       <button id="btn-open-saved-horizons" class="btn btn-xs btn-primary" onclick="document.getElementById('input-open-saved-horizons').click();" style="width: 100%; margin-bottom: 5px; height: 28px;">
                                          <i class="fa fa-folder-open"></i> Open Saved Horizons
                                       </button>
                                       <input type="file" id="input-open-saved-horizons" accept=".geojson,.json" style="display: none;" onchange="if(typeof window.handleSavedHorizonsFileSelect === 'function') { window.handleSavedHorizonsFileSelect(event); } else { alert('Load function not yet loaded. Please wait a moment and try again.'); }">
                                       <button id="btn-open-rise-set" class="btn btn-xs btn-primary" onclick="document.getElementById('input-open-rise-set').click();" style="width: 100%; height: 28px;">
                                          <i class="fa fa-folder-open"></i> Open Saved Rise/Set Locations
                                       </button>
                                       <input type="file" id="input-open-rise-set" accept=".geojson,.json" style="display: none;" onchange="if(typeof window.handleRiseSetFileSelect === 'function') { window.handleRiseSetFileSelect(event); } else { alert('Load function not yet loaded. Please wait a moment and try again.'); }">
                                    </div>
                                 </div>
                                 
                                 <!-- Profile and Panorama Options Section (Collapsible, not in lobipanel) -->
                                 <div class="style-panel" style="margin-top: 15px;">
                                    <details>
                                       <summary>
                                          <span class="fa fa-image text-primary"></span>&nbsp;Profile and Panorama Options
                                       </summary>
                                       <div class="panel-body">
                                          <div class="panel-help-link" onclick="togglePanelHelp('help-profile-panorama')" title="Info/Help">
                                             <span>Info/Help</span>
                                             <i class="fa fa-info-circle"></i>
                                          </div>
                                          <div class="panel-help-content" id="help-profile-panorama">
                                             <h5><i class="fa fa-info-circle"></i> Profile and Panorama Options</h5>
                                             <p>Control which visualization types are displayed in the Horizon Results panel:</p>
                                             <ul>
                                                <li><strong>Horizon Probe Chart:</strong> Displays the horizon profile as a line chart showing elevation angles in all directions.</li>
                                                <li><strong>Visual Horizon (Silhouette):</strong> Shows a panoramic silhouette view of the horizon with sky and ground colors.</li>
                                                <li><strong>Visual Horizon (Hillshade & Terrain):</strong> Displays a detailed terrain visualization with hillshading and color-coded elevation bands based on the configured palette.</li>
                                             </ul>
                                             <p><strong>Hillshade & Terrain Configuration:</strong> Customize the color palette used for terrain visualization. Each color stop represents an elevation threshold and corresponding color. The terrain is rendered with discrete color bands (no gradient interpolation) for clear elevation distinction.</p>
                                          </div>
                                          
                                          <div class="form-group" style="margin-top: 10px;">
                                             <label style="display:block; font-weight:bold; margin-bottom: 8px;">Show:</label>
                                             <div class="checkbox">
                                                <label>
                                                   <input type="checkbox" id="chk-show-chart" checked> Horizon Probe Chart
                                                </label>
                                             </div>
                                             <div class="checkbox">
                                                <label>
                                                   <input type="checkbox" id="chk-show-silhouette"> Visual Horizon (Silhouette)
                                                </label>
                                             </div>
                                             <div class="checkbox">
                                                <label>
                                                   <input type="checkbox" id="chk-show-hillshade" checked> Visual Horizon (Hillshade & Terrain)
                                                </label>
                                             </div>
                                          </div>
                                          
                                          <!-- Hillshade & Terrain Configuration (Collapsible) -->
                                          <div style="margin-top: 15px; border-top: 1px solid #ddd; padding-top: 10px;">
                                             <div class="style-panel">
                                                <details>
                                                   <summary>
                                                      <span class="fa fa-paint-brush"></span>&nbsp;Hillshade & Terrain Configuration
                                                   </summary>
                                                   <div class="panel-body">
                                                      <p class="small text-muted" style="margin-bottom: 10px;">Set elevation limit (m) and color for terrain visualization.</p>
                                                      <div id="hc-palette-rows" style="max-height: 250px; overflow-y: auto; margin-bottom: 10px;">
                                                         <!-- Rows injected via JS -->
                                                      </div>
                                                      <button class="btn btn-xs btn-block" style="margin-bottom:10px; background-color: #9b59b6; border-color: #8e44ad; color: white;" onmouseover="this.style.backgroundColor='#8e44ad'" onmouseout="this.style.backgroundColor='#9b59b6'" onclick="HC_addPaletteRow()">
                                                         <i class="fa fa-plus"></i> Add Color Stop
                                                      </button>
                                                      <hr style="margin: 10px 0;">
                                                      <div style="margin-top: 10px;">
                                                         <button class="btn btn-warning btn-xs pull-left" onclick="HC_resetPalette()">Reset Defaults</button>
                                                         <button class="btn btn-success btn-xs pull-right" onclick="HC_savePalette()">Apply & Recalculate</button>
                                                      </div>
                                                      <div style="clear: both;"></div>
                                                      <!-- Gradient Preview -->
                                                      <canvas id="hc-gradient-preview" style="width: 100%; height: 20px; border-radius: 3px; border: 1px solid #ccc; margin-top: 10px; display: block;"></canvas>
                                                      <hr style="margin: 15px 0 10px 0;">
                                                      <div class="text-center">
                                                         <button class="btn btn-primary btn-xs" onclick="HC_downloadPalette()" style="margin: 2px;"><i class="fa fa-download"></i> Save to File</button>
                                                         <button class="btn btn-danger btn-xs" onclick="HC_triggerUpload()" style="margin: 2px;"><i class="fa fa-upload"></i> Load from File</button>
                                                         <input type="file" id="hc-palette-file" style="display:none" accept=".json" onchange="HC_handlePaletteFile(this)">
                                                      </div>
                                                   </div>
                                                </details>
                                             </div>
                                          </div>
                                       </div>
                                    </details>
                                 </div>
                                 
                                    </div>
                                 </div>
                                    </div>
                                 </div>
                                    </div>
               </div>
            </div>
            <!-- Tab panes - Landscape Analysis -->
            <div class="leaflet-sidebar-pane" id="landscape">
               <h1 class="leaflet-sidebar-header"> Landscape Analysis <span class="leaflet-sidebar-close"><i class="fa fa-chevron-left"></i></span> </h1>
               <div>
                  <div class="poibar-table">
                     <div class="rightpadding">
                        <div id="lobipanel-multiple-landscape">
                           <div class="panel panel-default">
                              <div class="panel-heading">
                                 <div class="panel-title">
                                    <h1 class="panel-title"><span class="fa fa-sitemap text-primary"></span>&nbsp;Landscape Analysis</h1>
                                 </div>
                              </div>
                              <div class="panel-body">
                                 <!-- Intervisibility Analysis Section (Collapsible) -->
                                 <div class="style-panel" style="margin-top: 15px;">
                                    <details>
                                       <summary>
                                          <span class="fa fa-eye text-primary"></span>&nbsp;Intervisibility Analysis
                                       </summary>
                                       <div class="panel-body">
                                          <div class="panel-help-link" onclick="togglePanelHelp('help-intervisibility')" title="Info/Help">
                                             <span>Info/Help</span>
                                             <i class="fa fa-info-circle"></i>
                                          </div>
                                          <div class="panel-help-content" id="help-intervisibility">
                                             <h5><i class="fa fa-info-circle"></i> Intervisibility Analysis</h5>
                                             <p><strong>What is an Intervisibility Matrix?</strong></p>
                                             <p>An intervisibility matrix is a network analysis tool that determines which pairs of locations (sites) have direct line-of-sight visibility between them. It creates a binary adjacency matrix where each cell indicates whether two sites can see each other, accounting for terrain elevation, Earth's curvature, and atmospheric refraction.</p>
                                             <p><strong>Purpose and Applications:</strong></p>
                                             <ul>
                                                <li><strong>Archaeological Analysis:</strong> Identify potential communication networks, signaling systems, or ritual alignments between sites.</li>
                                                <li><strong>Strategic Planning:</strong> Understand defensive positions, watchtower placement, and territorial control.</li>
                                                <li><strong>Landscape Studies:</strong> Analyze how natural topography influences site relationships and visibility patterns.</li>
                                                <li><strong>Network Analysis:</strong> Study connectivity patterns to identify central hubs or isolated sites in a landscape.</li>
                                             </ul>
                                             <p><strong>How It Works:</strong></p>
                                             <ul>
                                                <li><strong>Open Marker Collection:</strong> Load a GeoJSON file containing marker locations (Point features). Sites are displayed as small purple circle markers.</li>
                                                <li><strong>Create Intervisibility Matrix:</strong> The system calculates line-of-sight between all site pairs using digital elevation data. Intervisible sites are connected with dashed grey lines on the map.</li>
                                                <li><strong>Calculation Process:</strong> For each site pair, the system:
                                                   <ul>
                                                      <li>Calculates a viewshed horizon profile from each site</li>
                                                      <li>Validates that the target site is above the horizon</li>
                                                      <li>Samples points along the sightline, accounting for Earth's curvature and atmospheric refraction</li>
                                                      <li>Checks if terrain obstructs the line-of-sight</li>
                                                   </ul>
                                                </li>
                                             </ul>
                                             <p><strong>Statistics Displayed:</strong></p>
                                             <ul>
                                                <li><strong>Intervisibility Ratio:</strong> Percentage of possible site pairs that are intervisible. Higher ratios indicate more connected landscapes.</li>
                                                <li><strong>Degree Centrality:</strong> Number of other sites visible from each site. Sites with high degree centrality are "visual hubs" in the network.</li>
                                                <li><strong>Clustering Coefficient:</strong> Measures how intervisible a site's neighbors are with each other. High clustering indicates tightly connected local groups.</li>
                                                <li><strong>Top 10 Most Intervisible Sites:</strong> Sites with the highest number of connections, indicating strategic or central locations.</li>
                                                <li><strong>Degree Distribution:</strong> Histogram showing how many sites have a specific number of visible connections, revealing network structure patterns.</li>
                                                <li><strong>Adjacency Matrix:</strong> Complete table showing all intervisibility relationships. Green cells indicate intervisible pairs, gray cells indicate blocked views.</li>
                                             </ul>
                                             <p><strong>Interpreting Results:</strong></p>
                                             <ul>
                                                <li>High intervisibility ratios suggest intentional site placement for communication or visibility.</li>
                                                <li>Sites with unusually high degree centrality may have been chosen for strategic or ritual significance.</li>
                                                <li>Clustering patterns can reveal subgroups or regional networks within the larger landscape.</li>
                                                <li>Isolated sites (low degree) may represent specialized functions or different cultural periods.</li>
                                             </ul>
                                          </div>
                                          
                                          <div class="form-group" style="margin-top: 10px;">
                                             <button id="btn-open-intervisibility-markers" class="btn btn-primary btn-xs btn-block" style="height: 28px; margin-bottom: 10px;">
                                                <i class="fa fa-folder-open"></i> Open Marker Collection
                                             </button>
                                             <input type="file" id="input-intervisibility-markers" accept=".geojson,.json" style="display: none;" onchange="handleIntervisibilityMarkersFile(event);">
                                             <button id="btn-create-intervisibility-matrix" class="btn btn-success btn-xs btn-block" style="height: 28px; margin-bottom: 10px;" disabled>
                                                <i class="fa fa-table"></i> Create Intervisibility Matrix
                                             </button>
                                             <button id="btn-pause-intervisibility" class="btn btn-warning btn-xs btn-block" style="height: 28px; margin-top: 10px; display: none;">
                                                <i class="fa fa-pause"></i> Pause Calculation
                                             </button>
                                             <button id="btn-resume-intervisibility" class="btn btn-success btn-xs btn-block" style="height: 28px; margin-top: 10px; display: none;">
                                                <i class="fa fa-play"></i> Resume Calculation
                                             </button>
                                             <button id="btn-cancel-intervisibility" class="btn btn-danger btn-xs btn-block" style="height: 28px; margin-top: 10px; display: none;">
                                                <i class="fa fa-times"></i> Cancel Calculation
                                             </button>
                                             <button id="btn-save-intervisibility-matrix" class="btn btn-primary btn-xs btn-block" style="height: 28px; margin-top: 10px; display: none;">
                                                <i class="fa fa-save"></i> Save Intervisibility Matrix
                                             </button>
                                             <button id="btn-load-intervisibility-matrix" class="btn btn-info btn-xs btn-block" style="height: 28px; margin-top: 10px;">
                                                <i class="fa fa-folder-open"></i> Load Saved Intervisibility Matrix
                                             </button>
                                             <input type="file" id="input-load-intervisibility-matrix" accept=".geojson,.json" style="display: none;">
                                             <button id="btn-view-intervisibility-statistics" class="btn btn-xs btn-block" onclick="if($('#iv-results-panel').is(':hidden') || $('#iv-results-panel').hasClass('minimized')) { $('#iv-results-panel').css('display', 'flex').removeClass('minimized').addClass('expanded'); $('#icon-toggle-iv').attr('class', 'fa fa-window-minimize'); } else { $('#iv-results-panel').css('display', 'flex').removeClass('minimized').addClass('expanded'); }" style="display: none; width: 100%; margin-top: 10px; height: 28px; background-color: #9b59b6; border-color: #8e44ad; color: white;" onmouseover="this.style.backgroundColor='#8e44ad'" onmouseout="this.style.backgroundColor='#9b59b6'">
                                                <i class="fa fa-bar-chart"></i> View Intervisibility Statistics
                                             </button>
                                             <button id="btn-generate-iv-report" class="btn btn-xs btn-block" style="width: 100%; margin-top: 10px; height: 28px; background-color: #2487CE; border-color: #1a6ba5; color: white;" disabled title="Generate IV report (available after creating intervisibility matrix)">
                                                <i class="fa fa-file-text-o"></i> Generate IV Report
                                             </button>
                                             <div id="intervisibility-status" class="status-message" style="margin-top: 10px; display: none; padding: 8px; background-color: #f0f0f0; border-radius: 4px; font-size: 12px;">
                                                <i class="fa fa-spinner fa-spin"></i> <span id="intervisibility-status-text">Calculating...</span>
                                             </div>
                                             <!-- Statistics Area (similar to horizon chart/panorama) -->
                                             <div id="intervisibility-statistics" style="margin-top: 15px; display: none; padding: 10px; background-color: #f9f9f9; border: 1px solid #ddd; border-radius: 4px;">
                                                <div class="section-title" style="font-weight: bold; margin-bottom: 10px; border-bottom: 1px solid #eee; padding-bottom: 5px;">
                                                   Intervisibility Statistics
                                                </div>
                                                <div style="font-size: 12px;">
                                                   <div style="margin-bottom: 5px;"><strong>Total Markers:</strong> <span id="stat-total-markers">0</span></div>
                                                   <div style="margin-bottom: 5px;"><strong>Total Possible Pairs:</strong> <span id="stat-total-pairs">0</span></div>
                                                   <div style="margin-bottom: 5px;"><strong>Intervisible Pairs:</strong> <span id="stat-intervisible-pairs">0</span></div>
                                                   <div style="margin-bottom: 5px;"><strong>Visibility Percentage:</strong> <span id="stat-visibility-percent">0</span>%</div>
                                                   <div style="margin-bottom: 5px;"><strong>Pairs Checked:</strong> <span id="stat-pairs-checked">0</span></div>
                                                </div>
                                             </div>
                                          </div>
                                       </div>
                                    </details>
                                 </div>
                                 
                                 <!-- Horizon Analysis Section (Collapsible) -->
                                 <div class="style-panel" style="margin-top: 15px;">
                                    <details>
                                       <summary>
                                          <span class="fa fa-area-chart text-primary"></span>&nbsp;Horizon Analysis
                                       </summary>
                                       <div class="panel-body">
                                          <!-- Horizon Analysis content will be added here -->
                                       </div>
                                    </details>
                                 </div>
                              </div>
                           </div>
                        </div>
                     </div>
                  </div>
               </div>
            </div>
            <!-- Tab panes - Image Overlay -->
            <div class="leaflet-sidebar-pane" id="image">
               <h1 class="leaflet-sidebar-header">Image Upload
                  <span class="leaflet-sidebar-close">
                  <i class="fa fa-chevron-left"></i>
                  </span>
               </h1>
               <div>
                  <div class="poibar-table">
                     <div class="rightpadding">
                        <div id="lobipanel-multiple21">
                           <div class="panel panel-default">
                              <div class="panel-heading">
                                 <div class="panel-title">
                                    <h1 class="panel-title"><span class="fa fa-image text-primary"></span>&nbsp;Image Upload
                                    </h1>
                                 </div>
                              </div>
                              <div class="panel-body">
                                 <div class="panel-help-link" onclick="togglePanelHelp('help-21')" title="Info/Help">
                                    <span>Info/Help</span>
                                    <i class="fa fa-info-circle"></i>
                                 </div>
                                 <div class="panel-help-content" id="help-21">
                                    <h5><i class="fa fa-info-circle"></i> Image Upload</h5>
                                    <p>Upload and georeference images to overlay on the map:</p>
                                    <ul>
                                       <li><strong>Drag & Drop:</strong> Drag image files or georeferenced ZIP files directly onto the upload area, or click to select files.</li>
                                       <li><strong>Supported Formats:</strong>
                                          <ul>
                                             <li>Image files: JPG, PNG, GIF, SVG</li>
                                             <li>Georeferenced files: ZIP archives containing images accompanying GeoJSON metadata</li>
                                          </ul>
                                       </li>
                                       <li><strong>Upload from URL:</strong> Enter an image URL (http/https) to load images directly from web servers. Useful for accessing remote imagery or tile services.</li>
                                       <li><strong>Georeferencing:</strong> If images include GeoJSON metadata, they will automatically align to the correct map position. Otherwise, you may need to manually position images using the image toolbar.</li>
                                       <li><strong>Image Toolbar:</strong> When an image is selected on the map, a toolbar appears with options to:
                                          <ul>
                                             <li><strong>Border:</strong> Toggle border visibility</li>
                                             <li><strong>Delete:</strong> Remove the image from the map</li>
                                             <li><strong>Distort:</strong> Adjust corner points to correct perspective</li>
                                             <li><strong>Drag:</strong> Move the image to a new position</li>
                                             <li><strong>Free Rotate:</strong> Rotate the image freely</li>
                                             <li><strong>Lock/Unlock:</strong> Lock or unlock the image for editing</li>
                                             <li><strong>Opacity:</strong> Adjust image transparency</li>
                                             <li><strong>Rotate:</strong> Rotate in 90-degree increments</li>
                                             <li><strong>Scale:</strong> Resize the image proportionally</li>
                                             <li><strong>Restore:</strong> Reset image to original state</li>
                                             <li><strong>Stack:</strong> Change image layer order</li>
                                             <li><strong>Export/Save:</strong> Save the geocoded image (available on the toolbar)</li>
                                          </ul>
                                       </li>
                                       <li><strong>Save Functionality:</strong> The save option is available on the image toolbar. Saved geocoded SVG files may be further edited after saving, but saved geocoded raster files (JPG, PNG, GIF) may not be further edited once saved.</li>
                                       <li><strong>Destroy All Overlays:</strong> Remove all uploaded images from the map in one action.</li>
                                    </ul>
                                    <p><strong>Note:</strong> Large images may take time to process. The system supports multiple simultaneous uploads with progress tracking. Georeferenced images will appear at their correct geographic location automatically.</p>
                                 </div>
                              <!-- File Upload Section -->
                              <!-- Image container begin -->
                              <!-- File Upload Section -->
                              <div class="form-group">
                                 <h2 class="h5-custom">Upload Images</h2>
                                 <!-- Updated drag-area to use Bootstrap's .well and .text-center -->
                                 <div id="drag-area" class="well text-center text-muted dm-uploader padding">
                                    Drag & Drop Images or Georeferenced Zip Files Here or Click to Select
                                 </div>
                                 <input type="file" id="file-input" accept="image/*, application/json, .zip" multiple class="hidden">
                                 <!-- Progress Bar Container -->
                                 <div id="progress-container" class="progress-container hidden">
                                    <div id="progress-bar" class="progress-bar">
                                       <span id="progress-text">0%</span>
                                    </div>
                                 </div>
                                 <div class="form-group-custom">
                                    <label for="image-url-input" class="control-label text-secondary h5-custom">Upload from URL:</label>
                                    <div class="input-group input-group-custom">
                                       <input type="url" id="image-url-input" placeholder="Enter image URL (http/https)"
                                          class="form-control text-dark">
                                       <span class="input-group-btn input-group-btn-custom">
                                       <button id="upload-url-btn" class="btn btn-primary">
                                       Upload
                                       </button>
                                       </span>
                                    </div>
                                 </div>
                                 <div id="status-message" class="text-small-custom"></div>
                              </div>
                              <!-- Image Management Section -->
                              <div style="flex: 1; margin-bottom: 15px;">
                                 <!-- Approximate flex-grow-1 and mb-4 -->
                                 <button id="destroy-all-btn"
                                    class="btn btn-danger full-width-btn">
                                 Destroy All Overlays
                                 </button>
                              </div>
                              <!-- Image container end -->
                              </div>
                           </div>
                        </div>
                     </div>
                  </div>
               </div>
            </div>
			<div class="leaflet-sidebar-pane" id="hwt">
               <h1 class="leaflet-sidebar-header">Markup
                  <span class="leaflet-sidebar-close">
                  <i class="fa fa-chevron-left"></i>
                  </span>
               </h1>
               <div>
                  <div class="poibar-table">
                     <div class="rightpadding">
                        <div id="lobipanel-multiple22">
                           <div class="panel panel-default">
                              <div class="panel-heading">
                                 <div class="panel-title">
                                    <h1 class="panel-title"><span class="fa fa-pencil text-primary"></span>&nbsp;Drawing Tools
                                    </h1>
                                 </div>
                              </div>
                              <div class="panel-body">
                                 <div class="panel-help-link" onclick="togglePanelHelp('help-22')" title="Info/Help">
                                    <span>Info/Help</span>
                                    <i class="fa fa-info-circle"></i>
                                 </div>
                                 <div class="panel-help-content" id="help-22">
                                    <h5><i class="fa fa-info-circle"></i> Drawing Tools</h5>
                                    <p>Draw and annotate features on the map with customizable styling:</p>
                                    <ul>
                                       <li><strong>Style Settings:</strong>
                                          <ul>
                                             <li><strong>Outline/Text Color:</strong> Set the border and text color for shapes and markers. Use the color picker or preset palette.</li>
                                             <li><strong>Line Width:</strong> Adjust the thickness of lines and borders (1-20px).</li>
                                             <li><strong>Dashed Stroke:</strong> Toggle between solid and dashed line styles.</li>
                                             <li><strong>Fill & Opacity:</strong> Set fill color and transparency (0-100%) for polygons and circles.</li>
                                          </ul>
                                       </li>
                                       <li><strong>Drawing Tools:</strong>
                                          <ul>
                                             <li><strong>Marker:</strong> Place point markers at specific locations</li>
                                             <li><strong>Polyline:</strong> Draw connected line segments</li>
                                             <li><strong>Polygon:</strong> Draw closed shapes with fill</li>
                                             <li><strong>Rectangle:</strong> Draw rectangular shapes</li>
                                             <li><strong>Circle:</strong> Draw circular areas</li>
                                             <li><strong>Text:</strong> Add text labels to the map</li>
                                          </ul>
                                       </li>
                                       <li><strong>Preset Markers:</strong> Quick placement of small, medium, or large markers with predefined sizes.</li>
                                       <li><strong>Arrow Options:</strong> Configure arrow placement and size for polylines to indicate direction.</li>
                                    </ul>
                                    <p><strong>Usage:</strong> 1) Configure your style preferences, 2) Select a drawing tool, 3) Click on the map to start drawing. For polygons and polylines, double-click to finish. All drawn features can be edited or deleted after creation.</p>
                                    <p><strong>Export/Import:</strong> Completed drawings may be exported for later use. Imported drawings will retain all saved styles including colors, line widths, fill opacity, and other formatting options.</p>
                                 </div>
                                 <p class="description-text">Select styling and a tool below.</p>
                                 
                                 <div class="tool-section-title">Style Settings</div>
                                 
                                 <!-- Outline Section -->
                                 <div class="style-panel">
                                    <details>
                                       <summary>Outline / Text Color</summary>
                                       <div class="panel-body">
                                          <label class="picker-label" for="outline-color">Custom Color Picker</label>
                                          <div class="input-group" style="width:100%; margin-bottom:10px;">
                                             <input type="color" id="outline-color" value="#333333" title="Pick a custom color" style="width:100%; border-radius:4px;">
                                          </div>
                                          
                                          <label class="picker-label">Presets</label>
                                          <div class="palette-grid" id="outline-palette"></div>
                                          
                                          <div class="form-group" style="margin-top: 15px;">
                                             <div style="display:flex; justify-content:space-between;">
                                                <label class="picker-label">Line Width</label>
                                                <span id="outline-weight-label" style="font-weight: bold; color: #333; font-size: 16px;">2px</span>
                                             </div>
                                             <input type="range" id="outline-weight" min="1" max="20" step="1" value="2" oninput="if(typeof window.drawingUI !== 'undefined') window.drawingUI.updateWeightLabel(this.value)" style="width:100%;">
                                          </div>

                                          <div class="checkbox">
                                             <label>
                                                <input type="checkbox" id="outline-dashed"> Dashed Stroke
                                             </label>
                                          </div>
                                       </div>
                                    </details>
                                 </div>

                                 <!-- Fill Section -->
                                 <div class="style-panel">
                                    <details>
                                       <summary>Fill & Opacity</summary>
                                       <div class="panel-body">
                                          <label class="picker-label" for="fill-color">Custom Fill Color</label>
                                          <div class="input-group" style="width:100%; margin-bottom:10px;">
                                             <input type="color" id="fill-color" value="#3388ff" title="Pick a custom color" style="width:100%; border-radius:4px;">
                                          </div>
                                          
                              <div class="form-group">
                                             <div style="display:flex; justify-content:space-between;">
                                                <label class="picker-label" for="fill-opacity">Opacity</label>
                                                <span id="opacity-label" style="font-weight: bold; color: #333;">100%</span>
                                    </div>
                                             <input type="range" id="fill-opacity" min="0" max="1" step="0.1" value="1" oninput="if(typeof window.drawingUI !== 'undefined') window.drawingUI.updateOpacityLabel(this.value)" style="width:100%;">
                                 </div>
                                          
                                          <label class="picker-label">Presets</label>
                                          <div class="palette-grid" id="fill-palette"></div>
                              </div>
                                    </details>
                              </div>

                                 <!-- Arrow Section -->
                                 <div class="style-panel">
                                    <details>
                                       <summary>Arrow Options</summary>
                                       <div class="panel-body">
							  <div class="form-group">
                                             <label class="picker-label" for="arrow-frequency">Placement</label>
                                             <select id="arrow-frequency" class="form-control input-sm">
                                                <option value="end">End Only</option>
                                                <option value="start-end">Start & End</option>
                                                <option value="repeat">Repeat (every 100px)</option>
                                             </select>
                                    </div>
                                          <div class="form-group">
                                             <div style="display:flex; justify-content:space-between;">
                                                <label class="picker-label" for="arrow-size">Size</label>
                                                <span id="arrow-size-label" style="font-weight: bold; color: #333; font-size: 16px;">15px</span>
                                 </div>
                                             <input type="range" id="arrow-size" min="5" max="30" step="1" value="15" oninput="if(typeof window.drawingUI !== 'undefined') window.drawingUI.updateArrowSizeLabel(this.value)" style="width:100%;">
                              </div>
                                       </div>
                                    </details>
                                 </div>

                                 <div class="tool-section-title">Preset Markers</div>
                                 <div class="row" style="margin: 0 -5px;">
                                    <div class="col-xs-4" style="padding: 0 5px;">
                                       <div class="tool-btn" id="btn-preset-small" onclick="if(typeof window.DrawingToolsApp !== 'undefined') window.DrawingToolsApp.startTool('preset-small')">
                                          <i class="fa fa-circle" style="font-size: 10px;"></i> Small
                                       </div>
                                    </div>
                                    <div class="col-xs-4" style="padding: 0 5px;">
                                       <div class="tool-btn" id="btn-preset-medium" onclick="if(typeof window.DrawingToolsApp !== 'undefined') window.DrawingToolsApp.startTool('preset-medium')">
                                          <i class="fa fa-circle" style="font-size: 14px;"></i> Medium
                                       </div>
                                    </div>
                                    <div class="col-xs-4" style="padding: 0 5px;">
                                       <div class="tool-btn" id="btn-preset-large" onclick="if(typeof window.DrawingToolsApp !== 'undefined') window.DrawingToolsApp.startTool('preset-large')">
                                          <i class="fa fa-circle" style="font-size: 20px;"></i> Large
                                       </div>
                                    </div>
                                 </div>

                                 <div class="tool-section-title">Create Shapes</div>
                                 <div class="row" style="margin: 0 -5px;">
                                    <div class="col-xs-4" style="padding: 0 5px;">
                                       <div class="tool-btn" id="btn-text" onclick="if(typeof window.DrawingToolsApp !== 'undefined') window.DrawingToolsApp.startTool('text')">
                                          <i class="fa fa-font"></i> Text
                                       </div>
                                    </div>
                                    <div class="col-xs-4" style="padding: 0 5px;">
                                       <div class="tool-btn" id="btn-marker" onclick="if(typeof window.DrawingToolsApp !== 'undefined') window.DrawingToolsApp.startTool('marker')">
                                          <i class="fa fa-map-marker"></i> Marker
                                       </div>
                                    </div>
                                    <div class="col-xs-4" style="padding: 0 5px;">
                                       <div class="tool-btn" id="btn-polyline" onclick="if(typeof window.DrawingToolsApp !== 'undefined') window.DrawingToolsApp.startTool('polyline')">
                                          <i class="fa fa-share-alt"></i> Line
                                       </div>
                                    </div>
                                    <div class="col-xs-4" style="padding: 0 5px;">
                                       <div class="tool-btn" id="btn-arrow" onclick="if(typeof window.DrawingToolsApp !== 'undefined') window.DrawingToolsApp.startTool('arrow')">
                                          <i class="fa fa-long-arrow-right"></i> Arrow
                                       </div>
                                    </div>
                                    <div class="col-xs-4" style="padding: 0 5px;">
                                       <div class="tool-btn" id="btn-polygon" onclick="if(typeof window.DrawingToolsApp !== 'undefined') window.DrawingToolsApp.startTool('polygon')">
                                          <i class="fa fa-pencil-square-o"></i> Polygon
                                       </div>
                                    </div>
                                    <div class="col-xs-4" style="padding: 0 5px;">
                                       <div class="tool-btn" id="btn-rectangle" onclick="if(typeof window.DrawingToolsApp !== 'undefined') window.DrawingToolsApp.startTool('rectangle')">
                                          <i class="fa fa-square-o"></i> Rect
                                       </div>
                                    </div>
                                    <div class="col-xs-4" style="padding: 0 5px;">
                                       <div class="tool-btn" id="btn-circle" onclick="if(typeof window.DrawingToolsApp !== 'undefined') window.DrawingToolsApp.startTool('circle')">
                                          <i class="fa fa-circle-o"></i> Circle
                                       </div>
                                    </div>
                                    <div class="col-xs-8" style="padding: 0 5px;">
                                       <div class="tool-btn" onclick="if(typeof window.DrawingToolsApp !== 'undefined') window.DrawingToolsApp.stopDrawing()" style="color: #d9534f; border-color: #d9534f;">
                                          <i class="fa fa-ban" style="color: #d9534f;"></i> Cancel
                                       </div>
                                    </div>
                                 </div>

                                 <div class="tool-section-title">Manage Layers</div>
                                 <div class="row" style="margin: 0 -5px;">
                                    <div class="col-xs-4" style="padding: 0 5px;">
                                       <div class="tool-btn" id="btn-edit" onclick="if(typeof window.DrawingToolsApp !== 'undefined') window.DrawingToolsApp.startEdit()">
                                          <i class="fa fa-pencil"></i> Edit
                                       </div>
                                    </div>
                                    <div class="col-xs-4" style="padding: 0 5px;">
                                       <div class="tool-btn" id="btn-delete" onclick="if(typeof window.DrawingToolsApp !== 'undefined') window.DrawingToolsApp.startDelete()">
                                          <i class="fa fa-trash"></i> Delete
                                       </div>
                                    </div>
                                    <div class="col-xs-4" style="padding: 0 5px;">
                                       <div class="tool-btn" onclick="if(typeof window.DrawingToolsApp !== 'undefined') window.DrawingToolsApp.saveActions()" style="color: #5cb85c; border-color: #5cb85c;">
                                          <i class="fa fa-check" style="color: #5cb85c;"></i> Save
                                       </div>
                                    </div>
                                 </div>

                                 <div id="drawn-items-list" class="stats-box">
                                    <strong>Stats:</strong>
                                    <div class="stat-item" style="margin-top:10px;"><span>Items Drawn:</span><span class="stat-value" id="item-count">0</span></div>
                                    <div class="stat-item" style="font-size:12px; color:#777; margin-top:5px;"><span id="status-msg">Ready to draw.</span></div>
                                 </div>

                                 <div style="margin-top: 20px; padding-bottom: 20px;">
                                    <button class="btn btn-primary btn-block mb-10" onclick="if(typeof window.DrawingToolsApp !== 'undefined' && window.DrawingToolsApp.drawingManager) window.DrawingToolsApp.drawingManager.fitBounds()">
                                       <i class="fa fa-search-plus"></i> Zoom to Drawn Items
                                 </button>
                                    <button class="btn btn-default btn-block mb-10" onclick="if(typeof window.drawingUI !== 'undefined') window.drawingUI.openConfirmModal()">
                                       <i class="fa fa-times"></i> Clear All Shapes
                                    </button>
                                    <hr>
                                    <div class="tool-section-title">Export / Import</div>
                                    <button class="btn btn-success btn-block mb-10" onclick="if(typeof window.DrawingToolsApp !== 'undefined') window.DrawingToolsApp.exportDrawings()">
                                       <i class="fa fa-download"></i> Export Drawings & Styles
                                    </button>
                                    <button class="btn btn-info btn-block" onclick="document.getElementById('import-drawings-input').click();">
                                       <i class="fa fa-upload"></i> Import Drawings & Styles
                                    </button>
                                    <input type="file" id="import-drawings-input" accept=".geojson,.json" style="display: none;" onchange="if(typeof window.DrawingToolsApp !== 'undefined') window.DrawingToolsApp.importDrawings(event);">
                              </div>
                              </div>
                           </div>
                        </div>
                     </div>
                  </div>
               </div>
            </div>
            <div class="leaflet-sidebar-pane" id="quickview">
               <h1 class="leaflet-sidebar-header"> Quick View <span class="leaflet-sidebar-close"><i class="fa fa-chevron-left"></i></span> </h1>
               <div>
                  <div class="poibar-table">
                     <div class="rightpadding">
                        <div id="lobipanel-quickview">
                           <div class="panel panel-default">
                              <div class="panel-heading">
                                 <div class="panel-title">
                                    <h1 class="panel-title"><span class="fa fa-eye text-primary"></span>&nbsp;Horizon Crossing Points</h1>
                                 </div>
                              </div>
                              <div class="panel-body">
                                 <div class="panel-help-link" onclick="togglePanelHelp('help-quickview')" title="Info/Help">
                                    <span>Info/Help</span>
                                    <i class="fa fa-info-circle"></i>
                                 </div>
                                 <div class="panel-help-content" id="help-quickview">
                                    <h5><i class="fa fa-info-circle"></i> Horizon Crossing Points</h5>
                                    <p>The Quick View panel displays horizon crossing points for celestial events calculated from your current location and parameters:</p>
                                    <ul>
                                       <li><strong>Solar Events:</strong> View sunrise and sunset positions for solstices, equinoxes, and cross-quarter days</li>
                                       <li><strong>Lunar Events:</strong> Access major and minor lunar standstill positions</li>
                                       <li><strong>Quick Navigation:</strong> Click any button to quickly zoom to and view the corresponding horizon crossing point on the map</li>
                                       <li><strong>Dynamic Updates:</strong> Buttons are automatically generated based on your current General Parameters settings (latitude, longitude, astronomical date)</li>
                                    </ul>
                                    <p><strong>Usage:</strong> Click any event button to center the map on that horizon crossing point. The map will zoom to show the location where the celestial body rises or sets on the terrain horizon.</p>
                                 </div>
                                 <!-- Buttons will be populated here by JavaScript -->
                              </div>
                           </div>
                        </div>
                     </div>
                  </div>
               </div>
            </div>
            <div class="leaflet-sidebar-pane" id="settings">
               <h1 class="leaflet-sidebar-header">About MACE<span class="leaflet-sidebar-close"><i class="fa fa-chevron-left"></i></span></h1>
               <div>
                  <div class="poibar-table">
                     <div class="rightpadding">
                        <div><img class="center-block" src="assets/img/macelogo.png" width="100"></div>
                        <div>
                           <h1 class="text-center">MACE</h1>
                        </div>
                        <div>
                           <p class="text-center">Mapped Archaeoastronomic Calculation & Exploration</p>
                        </div>
                        <div>
                           <p class="text-center">by</p>
                        </div>
                        <div>
                           <p class="text-center">Brian Doyle</p>
                        </div>
                        <div>
                           <p class="text-muted text-center"><i class="fa fa-envelope"></i> archaeoastronomyireland@gmail.com</p>
                        </div>
                        <div>
                           <p class="text-center"><em>With special thanks to:</em></p>
                        </div>
                        <div>
                           <p class="text-center">Victor Reijs</p>
                        </div>
                        <div>
                           <p class="text-center">Chris Veness</p>
                        </div>
                        <div>
                           <p class="text-center">Vladimir Agafonkin</p>
                        </div>
						<div>
                           <p class="text-center">All data and layers providers</p>
                        </div>
                     </div>
                  </div>
               </div>
            </div>
         </div>
      <div class="navbar navbar-default navbar-fixed-top" role="navigation">
         <div class="container-fluid">
            <div class="navbar-header">
               <button class="mobile-toggle" id="nav-btn" onclick="if(typeof window.map !== 'undefined' && window.map.sidebar) { window.map.sidebar.toggle(); }">
                  <i class="fa fa-bars"></i>
               </button>
               <i class="fa fa-dot-circle-o header-icon"></i>
               <span class="header-title">Archaeoastronomy Ireland</span>
            </div>
            <div class="navbar-spacer"></div>
            <a class="navbar-brand" href="#">MACE</a>
            <a href="https://github.com/kerbstone52/Mace" class="github-btn" title="View on GitHub">
               <i class="fa fa-github"></i>
            </a>
         </div>
      </div>
      <!-- Help Modal -->
      <!-- File item template -->
      <script type="text/html" id="files-template">
         <li class="media">
           <div class="media-body mb-1">
             <p class="mb-2">
               <strong>%%filename%%</strong> - Status: <span class="text-muted">Waiting</span>
             </p>
             <div class="progress">
               <div class="progress-bar progress-bar-striped progress-bar-animated bg-primary" 
                 role="progressbar"
                 style="width: 0%" 
                 aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
               </div>
             </div>
             <hr class="mt-1 mb-1" />
           </div>
         </li>
      </script>
      <!-- Debug item template -->
      <script type="text/html" id="debug-template">
         <li class="list-group-item text-%%color%%"><strong>%%date%%</strong>: %%message%%</li>
      </script>
      <form name="convert1" id="convert1">
         <input type="hidden" checked = "true" name="deg-format" id="deg-format-d" value="d" >
         <input type="hidden" name="deg-format" id="deg-format-dm" value="dm">
         <input type="hidden" name="deg-format" id="deg-format-dms" value="dms">
         <input type="file" class="ldi" id="inputimage" accept="image/*" />
      </form>
      <script src="assets/js/jquery.ui.touch-punch.min.js"></script> 
      <script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.5/js/bootstrap.min.js" integrity="sha512-K1qjQ+NcF2TYO/eI3M6v8EiNYZfA95pQumfvcVrTHtwQVDG+aHRqLi/ETn2uB+1JqwYqVG3LIvdm9lj6imS/pQ==" crossorigin="anonymous"></script> 
      <script src="https://unpkg.com/esri-leaflet@2.5.0/dist/esri-leaflet.js"
         integrity="sha512-ucw7Grpc+iEQZa711gcjgMBnmd9qju1CICsRaryvX7HJklK0pGl/prxKvtHwpgm5ZHdvAil7YPxI1oWPOWK3UQ=="
         crossorigin=""></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
      <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
      <script src="https://unpkg.com/esri-leaflet-renderers@3.0.0" crossorigin=""></script>
      <script src="https://unpkg.com/esri-leaflet-vector@4.2.3/dist/esri-leaflet-vector.js" crossorigin=""></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/mapbox-gl/3.3.0/mapbox-gl.js"></script>
      <script src="assets/js/lobipanel.js"></script>
      <script src="https://cdn.jsdelivr.net/npm/leaflet.wms@0.2.0/dist/leaflet.wms.min.js"></script>	  
      <script src="assets/js/tangram.min.js"></script> 
      <script src="assets/js/leaflet-touch-helper.js"></script> 
      <script src="assets/js/Control.Coordinates.js"></script> 
      <script src="assets/js/Leaflet.fullscreen.js"></script> 
      <script src="assets/js/leaflet-bing-layer.js"></script>
      <script src="assets/js/omphalopsychicsingle.js"></script>
      <script src="assets/js/leaflet-sidebar.js"></script> 
      <script src="assets/js/js.cookie.min.js"></script>
      <script src="assets/js/latlon-spherical.js"></script>
      <script src="assets/js/dms.js"></script>
      <script src="https://cdn.jsdelivr.net/npm/leaflet.geodesic"></script>
      <script src="assets/js/leaflet.zoomhome.min.js"></script>
      <script src="assets/js/imageoverlay.js"></script>
      <script src="https://unpkg.com/leaflet-kmz@latest/dist/leaflet-kmz.js"></script>
      <script src="https://unpkg.com/togeojson@0.16.0"></script>
      <script src="assets/js/leaflet.filelayer.js"></script>
      <script src="assets/js/fileopen.js"></script>
      <script src="assets/js/maphwt.js"></script>
      <script src="assets/js/LatLonControl.js"></script>
      <script src='https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js'></script>
      <script src="https://unpkg.com/leaflet-polylinedecorator@1.6.0/dist/leaflet.polylineDecorator.js"></script>
      <script src="assets/js/drawing-tools.js"></script>
      <script src="assets/imageoverlayjs/jquery.dm-uploader.min.js"></script>
      <script src="assets/imageoverlayjs/overlay-ui.js"></script>
      <script src="assets/imageoverlayjs/overlay-config.js"></script>
	  <script src="https://cdn.jsdelivr.net/npm/@turf/turf@7.2.0/turf.min.js"></script>
	  <script src="assets/js/hwtip.js"></script>
	  <script>
	  console.log('[index.html] About to load horizon-loadsave.js...');
	  </script>
	  <script src="assets/js/horizon-loadsave.js" onerror="console.error('FAILED TO LOAD horizon-loadsave.js'); alert('Error loading horizon-loadsave.js. Check console for details.');"></script>
	  <script>
	  console.log('[index.html] About to load horizon-profile-save.js...');
	  </script>
	  <script src="assets/js/horizon-profile-save.js" onerror="console.error('FAILED TO LOAD horizon-profile-save.js'); alert('Error loading horizon-profile-save.js. Check console for details.');" onload="setTimeout(function(){ console.log('[index.html] horizon-profile-save.js loaded. Functions:', { saveHorizonProfile: typeof window.saveHorizonProfile, handleSavedHorizonsFileSelect: typeof window.handleSavedHorizonsFileSelect }); }, 100);"></script>
	  <script src="assets/js/importexport.js"></script>
	  <script src="assets/js/Map_Services.js"></script>
	  <script src="assets/js/horizon.js"></script>
	  <script src="assets/js/horizon-image-export.js"></script>
	  <script src="assets/js/horizon-stellarium-export.js"></script>
	  <script src="assets/js/intervisibility-chunking.js"></script>
	  <script src="assets/js/iv-report-utils.js"></script>
	  <script src="assets/js/intervisibility.js"></script>

      <!-- GAZETTEER CONTROLS (Floating & Draggable) -->
      <div id="hc-gazetteer-controls" style="display: none;">
         <h5 style="margin-top:0;" title="Drag to move">Gazetteer Mode <i class="fa fa-arrows pull-right" style="font-size:12px; color:#ccc;"></i></h5>
         
         <p class="small text-muted" style="margin-bottom:8px;">
            <i class="fa fa-info-circle"></i> Click map location to add entry. Markers may be dragged into position.
         </p>
         
         <div style="max-height:300px; overflow-y:auto; margin-bottom:10px;">
            <table class="table table-condensed table-bordered" style="margin-bottom:0; font-size:11px;">
               <thead>
                  <tr>
                     <th style="width:30px;"></th>
                     <th>A (Az)</th>
                     <th>Alt</th>
                     <th>Label</th>
                     <th style="width:80px;">Bump </th>
                     <th style="width:80px;">Bump </th>
                  </tr>
               </thead>
               <tbody id="hc-gaz-table-body">
                  <tr id="hc-gaz-add-row">
                     <td colspan="6" style="text-align:center; padding:8px;">
                        <i class="fa fa-plus-circle" style="color:#5bc0de; font-size:16px;"></i>
                        <span class="small text-muted"> Click map to add entry</span>
                     </td>
                  </tr>
               </tbody>
            </table>
         </div>
         
         <div style="margin-top:10px;">
            <button class="btn btn-success btn-xs btn-block" onclick="HC_finishGazetteer()" style="margin-bottom:5px;">Finish & Download Zip</button>
            <button class="btn btn-default btn-xs btn-block" onclick="HC_cancelGazetteer()">Cancel</button>
         </div>
      </div>

      <!-- HORIZON RESULTS PANEL (Bottom of page) -->
      <div id="hc-results-panel" class="panel panel-default">
         <div class="panel-heading clearfix" id="results-header">
            <h4 class="panel-title"><i class="fa fa-area-chart"></i>&nbsp;Horizon Results</h4>
            <div class="btn-group pull-right">
               <button class="btn btn-default btn-xs" id="btn-toggle-results" title="Minimize/Expand"><i class="fa fa-window-minimize" id="icon-toggle"></i></button>
               <button class="btn btn-danger btn-xs" onclick="$('#hc-results-panel').hide();" title="Close"><i class="fa fa-times"></i></button>
            </div>
         </div>
         <div class="panel-body">
            <!-- Resolution Control Sections at Top -->
            <div class="row" style="margin-bottom: 15px;">
               <!-- Horizon Profile Resolution Section -->
               <div class="col-md-6" style="padding-right: 10px;">
                  <div style="padding: 10px; background-color: #f9f9f9; border-radius: 4px; border: 1px solid #ddd;">
                     <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <h5 style="margin: 0;">
                           <i class="fa fa-area-chart"></i> Horizon Profile Resolution
                        </h5>
                        <button id="btn-save-horizon-profile" class="btn btn-xs" disabled onclick="if(typeof window.saveHorizonProfile === 'function') { window.saveHorizonProfile(); } else { alert('Save function not yet loaded. Please wait a moment and try again.'); }" style="display: none; height: 28px; background-color: #9b59b6; border-color: #8e44ad; color: white;" onmouseover="this.style.backgroundColor='#8e44ad'" onmouseout="this.style.backgroundColor='#9b59b6'">
                           <i class="fa fa-save"></i> Save Horizon Profile
                        </button>
                     </div>
                     <div style="margin-bottom: 8px;">
                        <strong>Current Resolution:</strong> <span id="current-profile-resolution">Not Calculated</span>
                     </div>
                     <div id="profile-resolution-buttons" style="display: none;">
                        <label style="font-weight: normal; margin-bottom: 5px; display: block;">Upgrade to:</label>
                        <div style="display: flex; flex-wrap: wrap; gap: 5px;">
                           <button class="btn btn-xs btn-success" id="btn-profile-hires" onclick="if(typeof window.HC_upgradeProfileResolution === 'function') { window.HC_upgradeProfileResolution('hires'); }" style="display: none;">
                              Hi-Res
                           </button>
                           <button class="btn btn-xs btn-success" id="btn-profile-super" onclick="if(typeof window.HC_upgradeProfileResolution === 'function') { window.HC_upgradeProfileResolution('super'); }" style="display: none;">
                              Super
                           </button>
                           <button class="btn btn-xs btn-success" id="btn-profile-max" onclick="if(typeof window.HC_upgradeProfileResolution === 'function') { window.HC_upgradeProfileResolution('max'); }" style="display: none;">
                              Max
                           </button>
                        </div>
                     </div>
                  </div>
               </div>
               
               <!-- Rise/Set Resolution Section -->
               <div class="col-md-6" style="padding-left: 10px;">
                  <div style="padding: 10px; background-color: #f9f9f9; border-radius: 4px; border: 1px solid #ddd;">
                     <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <h5 style="margin: 0;">
                           <i class="fa fa-calculator"></i> Rise/Set Locations Resolution
                        </h5>
                        <button id="btn-save-rise-set" class="btn btn-xs" disabled onclick="if(typeof window.saveRiseSetLocations === 'function') { window.saveRiseSetLocations(); } else { alert('Save function not yet loaded. Please wait a moment and try again.'); }" style="display: none; height: 28px; background-color: #9b59b6; border-color: #8e44ad; color: white;" onmouseover="this.style.backgroundColor='#8e44ad'" onmouseout="this.style.backgroundColor='#9b59b6'">
                           <i class="fa fa-save"></i> Save Rise/Set Locations
                        </button>
                     </div>
                     <div style="margin-bottom: 8px;">
                        <strong>Current Resolution:</strong> <span id="current-riseset-resolution">Not Calculated</span>
                     </div>
                     <div id="riseset-resolution-buttons" style="display: none;">
                        <label style="font-weight: normal; margin-bottom: 5px; display: block;">Upgrade to:</label>
                        <div style="display: flex; flex-wrap: wrap; gap: 5px;">
                           <button class="btn btn-xs btn-primary" id="btn-riseset-hires" onclick="if(typeof window.HC_upgradeRiseSetResolution === 'function') { window.HC_upgradeRiseSetResolution('hires'); }" style="display: none;">
                              Hi-Res
                           </button>
                           <button class="btn btn-xs btn-primary" id="btn-riseset-super" onclick="if(typeof window.HC_upgradeRiseSetResolution === 'function') { window.HC_upgradeRiseSetResolution('super'); }" style="display: none;">
                              Super
                           </button>
                           <button class="btn btn-xs btn-primary" id="btn-riseset-max" onclick="if(typeof window.HC_upgradeRiseSetResolution === 'function') { window.HC_upgradeRiseSetResolution('max'); }" style="display: none;">
                              Max
                           </button>
                        </div>
                     </div>
                  </div>
               </div>
            </div>
            
            <div class="row" id="row-horizon-chart">
               <div class="col-md-12">
                  <div class="section-title clearfix">
                     <span class="pull-left">
                        Horizon Probe Chart 
                        <span id="results-status" style="margin-left:15px; font-weight:normal; font-size:12px; color:#555; font-style:italic;"></span>
                     </span>
                     <div class="pull-right" id="res-upgrade-controls">
                        <button class="btn btn-xs btn-warning" onclick="if(typeof window.HC_exportChartToCSV === 'function') { window.HC_exportChartToCSV(); } else { alert('Export function not available.'); }" style="margin-left: 5px;">
                           <i class="fa fa-download"></i> Export to CSV
                        </button>
                     </div>
                  </div>
                  <div class="chart-container">
                     <canvas id="hc-horizonChart"></canvas>
                  </div>
               </div>
            </div>

            <div class="row" id="row-visual-horizon-silhouette" style="display: none;">
               <div class="col-md-12">
                  <div class="section-title clearfix">
                     <span class="pull-left">Visual Horizon (Silhouette)</span>
                     <div class="pull-right">
                        <button class="btn btn-xs btn-default" onclick="HC_resetPano('pano')"><i class="fa fa-refresh"></i> Reset</button>
                        <button id="btn-show-rise-set-silhouette" class="btn btn-xs btn-info" onclick="HC_toggleRiseSetDisplay()" style="display:none;"><i class="fa fa-map-marker"></i> Show Rise/Set Locations</button>
                        <button class="btn btn-xs btn-success" onclick="HC_exportPanoramaImage('hc-panoCanvas', 'panorama-silhouette')"><i class="fa fa-download"></i> Export Image</button>
                        <button class="btn btn-xs btn-warning" onclick="HC_openExportModal()">Export Stellarium</button>
                     </div>
                  </div>
                  <div class="pano-container">
                     <div class="nav-arrow nav-left" id="pan-left"><i class="fa fa-chevron-left"></i></div>
                     <canvas id="hc-panoCanvas" class="interactive"></canvas>
                     <div class="nav-arrow nav-right" id="pan-right"><i class="fa fa-chevron-right"></i></div>
                  </div>
               </div>
            </div>

            <div class="row" id="row-visual-horizon-hillshade" style="display: none;">
               <div class="col-md-12">
                  <div class="section-title clearfix">
                     <span class="pull-left">Visual Horizon (Hillshade & Terrain)</span>
                     <div class="pull-right">
                        <button class="btn btn-xs btn-default" onclick="HC_resetPano('hillshade')"><i class="fa fa-refresh"></i> Reset</button>
                        <button id="btn-show-rise-set-hillshade" class="btn btn-xs btn-info" onclick="HC_toggleRiseSetDisplay()" style="display:none;"><i class="fa fa-map-marker"></i> Show Rise/Set Locations</button>
                        <button class="btn btn-xs btn-success" onclick="HC_exportPanoramaImage('hc-panoCanvasHillshade', 'panorama-hillshade')"><i class="fa fa-download"></i> Export Image</button>
                        <button class="btn btn-xs btn-warning" onclick="HC_openStellariumExportModal('hillshade')">Export Stellarium</button>
                     </div>
                  </div>
                  <div class="pano-container">
                     <div class="nav-arrow nav-left" id="pan-left-hillshade"><i class="fa fa-chevron-left"></i></div>
                     <canvas id="hc-panoCanvasHillshade" class="interactive"></canvas>
                     <div class="nav-arrow nav-right" id="pan-right-hillshade"><i class="fa fa-chevron-right"></i></div>
                  </div>
               </div>
            </div>
         </div>
      </div>

      <!-- INTERVISIBILITY STATISTICS PANEL (Bottom of page, similar to Horizon Results) -->
      <div id="iv-results-panel" class="panel panel-default" style="display: none; position: fixed; bottom: 0; left: 0; right: 0; width: 100%; z-index: 1000;">
         <div class="panel-heading clearfix" id="iv-results-header">
            <h4 class="panel-title"><i class="fa fa-bar-chart"></i>&nbsp;Intervisibility Analysis Statistics</h4>
            <div class="btn-group pull-right">
               <button class="btn btn-default btn-xs" id="btn-toggle-iv-results" title="Minimize/Expand"><i class="fa fa-window-minimize" id="icon-toggle-iv"></i></button>
               <button class="btn btn-danger btn-xs" onclick="$('#iv-results-panel').hide();" title="Close"><i class="fa fa-times"></i></button>
            </div>
         </div>
         <div class="panel-body">
            <!-- Key Metrics Row -->
            <div class="row">
               <div class="col-md-12">
                  <div class="section-title clearfix">
                     <span class="pull-left">Key Statistical Metrics</span>
                  </div>
                  <div class="row" style="margin-bottom: 15px;">
                     <div class="col-md-3">
                        <div style="padding: 10px; background-color: #f8f9fa; border-radius: 4px; text-align: center;">
                           <div style="font-size: 24px; font-weight: bold; color: #428bca;" id="stat-total-sites">0</div>
                           <div style="font-size: 12px; color: #666;">Total Sites</div>
                        </div>
                     </div>
                     <div class="col-md-3">
                        <div style="padding: 10px; background-color: #f8f9fa; border-radius: 4px; text-align: center;">
                           <div style="font-size: 24px; font-weight: bold; color: #5cb85c;" id="stat-intervisibility-ratio">0%</div>
                           <div style="font-size: 12px; color: #666;">Intervisibility Ratio</div>
                        </div>
                     </div>
                     <div class="col-md-3">
                        <div style="padding: 10px; background-color: #f8f9fa; border-radius: 4px; text-align: center;">
                           <div style="font-size: 24px; font-weight: bold; color: #f0ad4e;" id="stat-avg-degree">0</div>
                           <div style="font-size: 12px; color: #666;">Avg. Degree Centrality</div>
                        </div>
                     </div>
                     <div class="col-md-3">
                        <div style="padding: 10px; background-color: #f8f9fa; border-radius: 4px; text-align: center;">
                           <div style="font-size: 24px; font-weight: bold; color: #d9534f;" id="stat-clustering-coeff">0.00</div>
                           <div style="font-size: 12px; color: #666;">Clustering Coefficient</div>
                        </div>
                     </div>
                  </div>
               </div>
            </div>

            <!-- Top 10 Most Intervisible Sites -->
            <div class="row">
               <div class="col-md-6">
                  <div class="section-title clearfix">
                     <span class="pull-left">Top 10 Most Intervisible Sites</span>
                  </div>
                  <div style="max-height: 300px; overflow-y: auto; border: 1px solid #ddd; border-radius: 4px; padding: 10px;">
                     <table class="table table-condensed table-striped" style="margin-bottom: 0; font-size: 12px;">
                        <thead>
                           <tr>
                              <th>Rank</th>
                              <th>Site Name</th>
                              <th>Connections</th>
                              <th>% of Total</th>
                           </tr>
                        </thead>
                        <tbody id="top-sites-table">
                           <tr><td colspan="4" style="text-align: center; color: #999;">No data available</td></tr>
                        </tbody>
                     </table>
                  </div>
               </div>
               <div class="col-md-6">
                  <div class="section-title clearfix">
                     <span class="pull-left">Degree Distribution</span>
                  </div>
                  <div class="chart-container" style="height: 300px;">
                     <canvas id="iv-degree-chart"></canvas>
                  </div>
               </div>
            </div>

            <!-- Adjacency Matrix -->
            <div class="row" style="margin-top: 15px;">
               <div class="col-md-12">
                  <div class="section-title clearfix">
                     <span class="pull-left">Adjacency Matrix (Visibility Network)</span>
                     <div class="pull-right">
                        <button class="btn btn-xs btn-default" onclick="window.exportAdjacencyMatrix && window.exportAdjacencyMatrix()">
                           <i class="fa fa-download"></i> Export CSV
                        </button>
                     </div>
                  </div>
                  <div id="adjacency-matrix-wrapper" style="max-height: 400px; overflow-x: scroll !important; overflow-y: auto !important; border: 1px solid #ddd; border-radius: 4px; padding: 10px;">
                     <div id="adjacency-matrix-container" style="font-size: 10px; display: inline-block;">
                        <p style="text-align: center; color: #999;">Adjacency matrix will be displayed here</p>
                     </div>
                  </div>
               </div>
            </div>
         </div>
      </div>

      <!-- STELLARIUM EXPORT PANEL (Floating & Draggable) -->
      <div id="hc-stellarium-export-panel" style="display: none;">
         <h5 style="margin-top:0;" title="Drag to move">Export to Stellarium <i class="fa fa-arrows pull-right" style="font-size:12px; color:#ccc;"></i></h5>
         <div style="padding: 15px;">
            <div class="form-group" style="margin-bottom:10px;">
               <label style="font-size:12px; margin-bottom:3px;">Landscape Name (File Name)</label>
               <input type="text" class="form-control input-sm" id="hc-export-name" value="MyHorizon">
            </div>
            <div class="form-group" style="margin-bottom:10px;">
               <label style="font-size:12px; margin-bottom:3px;">Author</label>
               <input type="text" class="form-control input-sm" id="hc-export-author" value="HorizonProfiler">
            </div>
            <div class="form-group" style="margin-bottom:10px;">
               <label style="font-size:12px; margin-bottom:3px;">Description</label>
               <textarea class="form-control input-sm" id="hc-export-description" rows="2" style="resize:vertical;"></textarea>
            </div>
            <div style="margin-top:15px;">
               <button type="button" class="btn btn-primary btn-xs btn-block" id="hc-btn-proceed-export" onclick="HC_proceedExport()" style="margin-bottom:5px;">Save Zip</button>
               <button type="button" class="btn btn-default btn-xs btn-block" onclick="HC_cancelStellariumExport()">Cancel</button>
            </div>
         </div>
      </div>
   </body>
</html>